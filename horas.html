<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT CONTROL | Buscador & Alertas</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .day-box { width: 19px; height: 19px; border-radius: 4px; font-size: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: bold; }
        .spr-high { background-color: #2563eb; color: white; }
        .vic-high { background-color: #f97316; color: white; }
        .day-off { background-color: #ffffff; color: #cbd5e1; border: 1px solid #e2e8f0; }
        .badge-activo { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 800; }
        .badge-inactivo { background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 800; }
        #login_layer { position: fixed; inset: 0; background: #0f172a; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .sticky-thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; border-bottom: 2px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <nav style="background: #0f172a; padding: 12px; display: flex; justify-content: center; gap: 15px; border-bottom: 3px solid #1e293b; font-family: sans-serif;">
        <a href="index.html" style="text-decoration: none; font-size: 11px; font-weight: 900; padding: 10px 20px; border-radius: 8px; background: #2563eb; color: white; border: 1px solid #3b82f6; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);">
            üìä DASHBOARD HORAS
        </a>
        <a href="ventas.html" style="text-decoration: none; font-size: 11px; font-weight: 900; padding: 10px 20px; border-radius: 8px; background: #1e293b; color: #94a3b8; border: 1px solid #334155;">
            üí∞ DASHBOARD VENTAS
        </a>
    </nav>

    <div id="login_layer">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border-t-4 border-blue-600">
            <h2 class="text-2xl font-black mb-2 uppercase tracking-tighter">GMT SISTEMA</h2>
            <form id="form_acceso" class="space-y-4">
                <input type="text" id="user_name" placeholder="USUARIO" required class="w-full p-4 border-2 rounded-xl text-center font-bold outline-none focus:border-blue-500">
                <input type="password" id="pass" placeholder="CONTRASE√ëA" required class="w-full p-4 border-2 rounded-xl text-center font-bold outline-none focus:border-blue-500">
                <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black shadow-lg uppercase">Entrar</button>
            </form>
        </div>
    </div>

    <div id="dashboard_wrapper" class="hidden p-4 md:p-8 max-w-7xl mx-auto">
        <div class="bg-white p-6 rounded-xl shadow-sm border mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-black uppercase text-slate-900">GMT CONTROL | <span class="text-blue-600">DETALLE DE HORAS</span></h1>
                <p id="label_current_date" class="text-[10px] font-bold text-slate-400 uppercase italic">Control de Conexi√≥n 2026</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <select id="filter_camp" class="bg-emerald-50 text-emerald-700 text-[10px] font-black px-4 py-2 rounded-full outline-none border border-emerald-100">
                    <option value="">TODAS LAS CAMPA√ëAS</option>
                </select>
                <select id="filter_month" class="bg-blue-50 text-blue-700 text-[10px] font-black px-4 py-2 rounded-full outline-none"></select>
                <select id="filter_week" class="bg-slate-100 text-[10px] font-black px-4 py-2 rounded-full outline-none"></select>
                <button onclick="document.getElementById('csv_input').click()" class="bg-slate-800 text-white px-5 py-2 rounded-full text-[10px] font-black uppercase shadow-md">üìÇ CARGAR DATA</button>
                <input type="file" id="csv_input" class="hidden">
                <button id="btn_excel" onclick="generarExcel()" class="hidden bg-emerald-600 text-white px-5 py-2 rounded-full text-[10px] font-black shadow-md uppercase">üìä EXCEL</button>
            </div>
        </div>

        <div id="main_content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-white p-4 rounded-xl border-l-4 border-blue-500 shadow-sm"><p class="text-[9px] font-bold text-slate-400 uppercase">Sprinklr</p><p id="k_spr" class="text-lg font-black text-blue-600">0:00:00</p></div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-orange-500 shadow-sm"><p class="text-[9px] font-bold text-slate-400 uppercase">Vicidial</p><p id="k_vic" class="text-lg font-black text-orange-600">0:00:00</p></div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-slate-800 shadow-sm"><p class="text-[9px] font-bold text-slate-400 uppercase">Total Selecci√≥n</p><p id="k_tot" class="text-lg font-black text-slate-800">0:00:00</p></div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm"><p class="text-[9px] font-bold text-red-500 uppercase italic">Casos Cr√≠ticos</p><p id="k_inact" class="text-lg font-black text-red-600">0</p></div>
            </div>

            <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mb-8 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div><p class="text-[8px] opacity-60 uppercase font-bold">Acumulado Periodo</p><p id="acum_sem" class="text-sm font-black text-orange-400">0h</p></div>
                <div><p class="text-[8px] opacity-60 uppercase font-bold">D√≠as en Vista</p><p id="acum_dias" class="text-sm font-black text-white">0</p></div>
                <div><p class="text-[8px] opacity-60 uppercase font-bold">Promedio Diario</p><p id="acum_prom" class="text-sm font-black text-emerald-400">0h</p></div>
                <div><p class="text-[8px] opacity-60 uppercase font-bold">Data Status</p><p class="text-sm font-black text-blue-400">ONLINE</p></div>
            </div>

            <div id="alerta_panel" class="hidden bg-white border border-red-200 rounded-xl mb-8 overflow-hidden shadow-sm">
                <div class="bg-red-600 p-3 flex justify-between items-center">
                    <span class="text-white text-[10px] font-black uppercase tracking-widest">‚ö†Ô∏è ALERTAS DE INACTIVIDAD (>= 2 D√çAS)</span>
                    <input type="text" id="search_user" placeholder="BUSCAR EJECUTIVO..." class="bg-white/20 text-white placeholder-white/60 text-[9px] px-3 py-1 rounded-lg border border-white/30 outline-none focus:bg-white focus:text-slate-900 transition-all w-48 uppercase font-bold">
                </div>
                <div class="max-h-60 overflow-y-auto"><table class="w-full text-[10px] text-left">
                    <thead class="sticky-thead font-bold uppercase text-slate-500">
                        <tr><th class="p-3">Ejecutivo</th><th class="p-3 text-center">D√≠as Activos</th><th class="p-3 text-center">Inactividad</th><th class="p-3">Cnx Total</th><th class="p-3">Campa√±a</th><th class="p-3">Gerencia</th></tr>
                    </thead>
                    <tbody id="t_body_alerts" class="divide-y divide-slate-100"></tbody>
                </table></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md border mb-8"><div id="g_weekly" style="height: 350px;"></div></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md border"><div id="g_bar" style="height: 450px;"></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md border"><div id="g_pie" style="height: 450px;"></div></div>
            </div>

            <div class="bg-slate-900 p-6 rounded-xl flex flex-col items-center gap-2 mb-8 shadow-xl">
                <p class="text-white text-[9px] font-bold opacity-40 uppercase mb-1">Visualizar Calendario por Gerencia</p>
                <select id="filter_ger" class="bg-white text-slate-800 text-xs font-black p-3 rounded-xl w-72 outline-none cursor-pointer"></select>
            </div>

            <div id="detail_sections" class="hidden">
                <div class="bg-white rounded-xl shadow-lg border border-slate-300 overflow-hidden mb-10">
                    <div class="overflow-x-auto"><table class="w-full text-[10px] border-collapse"><tbody id="t_body_calendar" class="divide-y divide-slate-50"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const USERS_DB = { "JSOROZCO": "gmt2026_1", "MACERON": "gmt2026_2", "JMMALDONADO": "gmt2026_3", "ADMIN": "gmt2026" };
        let rawDataFRows = [], globalDates = [], groupedData = {}, monthsFound = {};

        document.getElementById('form_acceso').onsubmit = e => {
            e.preventDefault();
            const u = document.getElementById('user_name').value.toUpperCase().trim();
            const p = document.getElementById('pass').value;
            if(USERS_DB[u] === p) {
                document.getElementById('login_layer').style.display = 'none';
                document.getElementById('dashboard_wrapper').classList.remove('hidden');
            } else { alert("Error de acceso"); }
        };

        document.getElementById('csv_input').onchange = e => { 
            const reader = new FileReader(); 
            reader.onload = f => procesarCSV(f.target.result); 
            reader.readAsText(e.target.files[0]); 
        };

        function tToSec(t) { 
            if(!t) return 0;
            const clean = t.toString().replace(/['"]+/g, '').trim();
            const p = clean.split(':');
            return (parseInt(p[0]) || 0) * 3600 + (parseInt(p[1]) || 0) * 60 + (parseInt(p[2]) || 0);
        }

        function secToT(s) { 
            const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sc = s%60;
            return `${h}:${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`; 
        }

        function procesarCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== "");
            const headers = lines[0].split(',');
            globalDates = headers.slice(9).map(d => d.trim().replace(/['"]+/g, ''));
            
            monthsFound = {};
            globalDates.forEach((d, idx) => {
                const parts = d.split('/');
                const monthKey = parts[1];
                if(!monthsFound[monthKey]) monthsFound[monthKey] = { name: "MES "+monthKey, indices: [] };
                monthsFound[monthKey].indices.push(idx);
            });

            const ms = document.getElementById('filter_month');
            ms.innerHTML = '<option value="ALL">TOTAL PERIODO</option>';
            Object.keys(monthsFound).sort().forEach(m => ms.innerHTML += `<option value="${m}">${monthsFound[m].name}</option>`);

            rawDataFRows = []; groupedData = {}; 
            let caps = new Set();
            lines.slice(1).forEach(line => {
                const c = line.split(','); if (c.length < 10) return;
                const sis = c[0].replace(/['"]+/g, '').toUpperCase().trim(); 
                const name = c[1].replace(/['"]+/g, '').trim(); 
                const ger = (c[3] || '').replace(/['"]+/g, '').trim().toUpperCase() || "#N/D";
                const camp = (c[4] || '').replace(/['"]+/g, '').trim().toUpperCase() || "#N/D";
                const est = (c[8] || 'ACTIVO').replace(/['"]+/g, '').trim();
                const daily = c.slice(9);
                
                caps.add(camp);
                rawDataFRows.push({ sis, name, ger, camp, est, daily });
                if(!groupedData[name]) groupedData[name] = { name, ger, camp, est, systems: {} };
                groupedData[name].systems[sis] = { daily };
            });

            document.getElementById('filter_camp').innerHTML = '<option value="">TODAS LAS CAMPA√ëAS</option>' + [...caps].sort().map(x => `<option value="${x}">${x}</option>`).join('');
            
            const gers = [...new Set(rawDataFRows.map(d => d.ger))].sort();
            document.getElementById('filter_ger').innerHTML = '<option value="">-- TODAS LAS GERENCIAS --</option>' + gers.map(g => `<option value="${g}">${g}</option>`).join('');
            document.getElementById('main_content').classList.remove('hidden');
            document.getElementById('btn_excel').classList.remove('hidden');
            actualizarSemanas();
        }

        function obtenerRangoActual() {
            const m = document.getElementById('filter_month').value;
            const w = document.getElementById('filter_week').value;
            let idxs = m === "ALL" ? globalDates.map((_,i)=>i) : monthsFound[m].indices;
            if(w === "ALL") return idxs;
            return idxs.slice(parseInt(w)*7, (parseInt(w)+1)*7);
        }

        function actualizarSemanas() {
            const mKey = document.getElementById('filter_month').value;
            const ws = document.getElementById('filter_week');
            let baseDates = mKey === "ALL" ? globalDates : monthsFound[mKey].indices;
            ws.innerHTML = '<option value="ALL">VISTA MENSUAL</option>';
            for(let i=0; i < Math.ceil(baseDates.length/7); i++) ws.innerHTML += `<option value="${i}">SEM ${i+1}</option>`;
            renderDashboard(); 
        }

        function renderDashboard() {
            const ger = document.getElementById('filter_ger').value;
            const camp = document.getElementById('filter_camp').value;
            const rango = obtenerRangoActual();

            let s_spr = 0, s_vic = 0, s_total = 0, sprV = [], vicV = [], labels = [];
            const campMap = {};
            let filtered = rawDataFRows.filter(r => (!ger || r.ger === ger) && (!camp || r.camp === camp));

            rango.forEach(idx => {
                labels.push(globalDates[idx].substring(0,5));
                let dS = 0, dV = 0;
                filtered.forEach(r => {
                    const s = tToSec(r.daily[idx]);
                    if(r.sis.includes('SPRINKLR')) dS += s; else dV += s;
                    if(s > 0) {
                        if(!campMap[r.camp]) campMap[r.camp] = { s: 0, sis: r.sis };
                        campMap[r.camp].s += s;
                    }
                });
                s_spr += dS; s_vic += dV; s_total += (dS + dV);
                sprV.push((dS/3600).toFixed(1)); vicV.push((dV/3600).toFixed(1));
            });

            document.getElementById('k_spr').innerText = secToT(s_spr);
            document.getElementById('k_vic').innerText = secToT(s_vic);
            document.getElementById('k_tot').innerText = secToT(s_total);
            document.getElementById('acum_sem').innerText = (s_total/3600).toFixed(1) + "h";
            document.getElementById('acum_dias').innerText = rango.length;
            document.getElementById('acum_prom').innerText = ((s_total/3600)/(rango.length || 1)).toFixed(1) + "h/d";

            Plotly.newPlot('g_weekly', [
                { x: labels, y: sprV, name: 'Sprinklr', type: 'scatter', mode: 'lines+markers+text', text: sprV, textposition: 'top center', line: {color: '#2563eb'} },
                { x: labels, y: vicV, name: 'Vicidial', type: 'scatter', mode: 'lines+markers+text', text: vicV, textposition: 'bottom center', line: {color: '#f97316'} }
            ], { title: 'TENDENCIA (H)', margin: {t:60,b:40,l:40,r:20} });

            Plotly.newPlot('g_pie', [{
                labels: ['Sprinklr', 'Vicidial'], values: [s_spr, s_vic], type: 'pie', textinfo: 'label+percent+value',
                marker: { colors: ['#2563eb', '#f97316'] }
            }], { title: 'BALANCE SISTEMAS' });

            const sortedC = Object.keys(campMap).map(k => ({n: k, s: (campMap[k].s/3600).toFixed(1), sis: campMap[k].sis})).sort((a,b) => a.s - b.s).slice(-10);
            Plotly.newPlot('g_bar', [{
                x: sortedC.map(x => x.s), y: sortedC.map(x => x.n), type: 'bar', orientation: 'h', text: sortedC.map(x => x.s + "h"), textposition: 'auto',
                marker: { color: sortedC.map(x => x.sis.includes('SPRINKLR') ? '#2563eb' : '#f97316') }
            }], { title: 'TOP 10 CAMPA√ëAS (HORAS)', margin: { l: 150 } });

            renderAlerts();
            if(ger) renderCalendar(ger);
        }

        function renderAlerts() {
            const ger = document.getElementById('filter_ger').value;
            const camp = document.getElementById('filter_camp').value;
            const query = document.getElementById('search_user').value.toUpperCase();
            const rango = obtenerRangoActual();

            const userMetrics = Object.values(groupedData).map(u => {
                let totalSec = 0, diasAct = 0;
                rango.forEach(idx => {
                    let cnxDia = 0;
                    Object.values(u.systems).forEach(sys => cnxDia += tToSec(sys.daily[idx]));
                    if(cnxDia > 0) diasAct++;
                    totalSec += cnxDia;
                });
                return { ...u, totalSec, diasActivos: diasAct, inact: rango.length - diasAct };
            });

            const alerts = userMetrics.filter(x => 
                x.totalSec > 0 && x.inact >= 2 && (!ger || x.ger === ger) && (!camp || x.camp === camp) && x.name.toUpperCase().includes(query)
            );
            
            document.getElementById('k_inact').innerText = alerts.length;
            document.getElementById('alerta_panel').classList.toggle('hidden', Object.values(groupedData).length === 0);
            
            document.getElementById('t_body_alerts').innerHTML = alerts.sort((a,b)=>b.inact - a.inact).map(i => `
                <tr class="hover:bg-slate-50">
                    <td class="p-3 font-bold uppercase">${i.name}</td>
                    <td class="p-3 text-center text-blue-600">${i.diasActivos} D</td>
                    <td class="p-3 text-center text-red-600 font-black bg-red-50">${i.inact} D</td>
                    <td class="p-3 font-bold">${secToT(i.totalSec)}</td>
                    <td class="p-3 uppercase text-slate-400 font-bold">${i.camp}</td>
                    <td class="p-3 uppercase text-slate-500">${i.ger}</td>
                </tr>`).join('');
        }

        document.getElementById('search_user').addEventListener('input', () => {
            renderAlerts();
            const ger = document.getElementById('filter_ger').value;
            if(ger) renderCalendar(ger);
        });

        document.getElementById('filter_camp').onchange = () => renderDashboard();
        document.getElementById('filter_month').onchange = () => actualizarSemanas();
        document.getElementById('filter_week').onchange = () => renderDashboard();
        document.getElementById('filter_ger').onchange = (e) => { 
            renderDashboard(); 
            if(e.target.value) { 
                document.getElementById('detail_sections').classList.remove('hidden'); 
            } else { 
                document.getElementById('detail_sections').classList.add('hidden'); 
            }
        };

        function renderCalendar(ger) {
            let h = ""; 
            const query = document.getElementById('search_user').value.toUpperCase();
            const camp = document.getElementById('filter_camp').value;
            const rango = obtenerRangoActual();
            const f = Object.values(groupedData).filter(d => 
                d.ger === ger && d.name.toUpperCase().includes(query) && (!camp || d.camp === camp)
            ).sort((a,b)=>a.name.localeCompare(b.name));

            f.forEach(d => {
                h += `<tr class="bg-slate-800 text-white font-bold text-[9px]"><td colspan="2" class="p-2 pl-4 uppercase">${d.name} [${d.camp}]</td></tr>`;
                Object.keys(d.systems).forEach(s => {
                    const dots = rango.map(idx => {
                        const v = d.systems[s].daily[idx];
                        return `<div class="day-box ${tToSec(v)>0?(s.includes('SPRINKLR')?'spr-high':'vic-high'):'day-off'}">${globalDates[idx].split('/')[0]}</div>`;
                    }).join('');
                    h += `<tr><td class="p-2 text-[8px] pl-6 w-24 text-slate-400 font-bold">${s}</td><td class="p-2 flex flex-wrap gap-1">${dots}</td></tr>`;
                });
            });
            document.getElementById('t_body_calendar').innerHTML = h;
        }

        function generarExcel() {
            const ger = document.getElementById('filter_ger').value;
            const camp = document.getElementById('filter_camp').value;
            const rango = obtenerRangoActual();
            const query = document.getElementById('search_user').value.toUpperCase();

            const data = Object.values(groupedData)
                .map(u => {
                    let sec = 0, act = 0;
                    rango.forEach(idx => {
                        let cnx = 0; Object.values(u.systems).forEach(sys => cnx += tToSec(sys.daily[idx]));
                        if(cnx > 0) act++; sec += cnx;
                    });
                    return { "EJECUTIVO": u.name, "GERENCIA": u.ger, "CAMPA√ëA": u.camp, "HORAS TOTALES": secToT(sec), "D√çAS ACT": act, "D√çAS INACT": rango.length - act };
                })
                .filter(x => (!ger || x.GERENCIA === ger) && (!camp || x.CAMPA√ëA === camp) && x.EJECUTIVO.toUpperCase().includes(query))
                .sort((a, b) => b["D√çAS INACT"] - a["D√çAS INACT"]);

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Auditoria_GMT");
            XLSX.writeFile(wb, `GMT_AUDITORIA.xlsx`);
        }
    </script>
</body>
</html>