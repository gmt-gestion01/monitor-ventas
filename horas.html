<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT CONTROL | Sprinklr Activos</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .day-box { width: 20px; height: 20px; border-radius: 4px; font-size: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: bold; border: 1px solid rgba(0,0,0,0.05); }
        .spr-high { background-color: #2563eb; color: white; }
        .day-off { background-color: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .sticky-thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; border-bottom: 2px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-sm border mb-6 flex flex-col lg:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-black uppercase tracking-tighter text-slate-900">GMT <span class="text-blue-600">SPRINKLR</span></h1>
                <p id="file_status" class="text-[10px] font-bold text-red-500 uppercase">üìä Solo Personal Activo</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-2">
                <input type="file" id="csv_input" accept=".csv" class="hidden">
                <button onclick="document.getElementById('csv_input').click()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-md hover:bg-blue-700 transition-all">üìÇ Cargar CSV</button>
                <select id="sel_mes" class="bg-white text-slate-700 text-[10px] font-black px-4 py-2 rounded-xl border outline-none cursor-pointer"></select>
                <select id="sel_ger" class="bg-white text-slate-700 text-[10px] font-black px-4 py-2 rounded-xl border outline-none cursor-pointer"></select>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border mb-6 shadow-sm">
            <div id="chart_div" style="height: 350px;"></div>
        </div>

        <div class="mb-6">
            <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                <div class="bg-red-600 p-3 flex justify-between items-center">
                    <h2 class="text-white font-black text-xs uppercase tracking-widest">‚ö†Ô∏è ALERTAS ACTIVOS (>2 D√çAS OFF)</h2>
                    <span id="count_alerts" class="bg-white text-red-600 text-[10px] px-2 py-1 rounded-lg font-black">0</span>
                </div>
                <div class="max-h-60 overflow-y-auto">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-slate-50 text-slate-500 font-bold uppercase border-b">
                            <tr>
                                <th class="p-3">Ejecutivo</th>
                                <th class="p-3">Gerencia</th>
                                <th class="p-3 text-center">Inactividad</th>
                            </tr>
                        </thead>
                        <tbody id="table_alerts" class="divide-y divide-slate-100 italic text-slate-400">
                            <tr><td colspan="3" class="p-6 text-center">Sin datos cargados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                <input type="text" id="search_box" placeholder="BUSCAR EJECUTIVO..." class="w-full max-w-sm px-4 py-2 text-xs border rounded-lg outline-none font-bold uppercase">
                <p id="total_acumulado" class="text-xs font-black text-blue-600 uppercase"></p>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
                <table class="w-full text-left text-[11px]">
                    <thead class="sticky-thead bg-slate-50 text-slate-500 font-bold uppercase">
                        <tr>
                            <th class="p-4">Informaci√≥n del Agente</th>
                            <th class="p-4 text-center">Calendario</th>
                            <th class="p-4 text-right">Horas</th>
                        </tr>
                    </thead>
                    <tbody id="table_body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataGlobal = {}, fechasGlobal = [], mesesDisp = {};

        document.getElementById('csv_input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { procesarCSV(e.target.result); };
            reader.readAsText(file);
        });

        function t2s(t) {
            if (!t) return 0;
            const p = t.toString().split(':');
            return p.length < 2 ? 0 : (+p[0] * 3600) + (+p[1] * 60) + (+p[2] || 0);
        }

        function s2t(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return `${h}:${m.toString().padStart(2, '0')}`;
        }

        function procesarCSV(csv) {
            const lineas = csv.split(/\r?\n/).filter(l => l.trim().length > 10);
            const sep = lineas[0].includes(';') ? ';' : ',';
            const cab = lineas[0].split(sep).map(h => h.trim().toUpperCase());
            
            const iAg = cab.indexOf("AGENTE"), iHr = cab.indexOf("HORAS LOGUEO"),
                  iDi = cab.indexOf("DIA"), iMe = cab.indexOf("MES"),
                  iSi = cab.indexOf("SISTEMA"), iGe = cab.indexOf("GERENCIA"),
                  iEs = cab.indexOf("ESTATUS"); // Detectamos columna Estatus

            dataGlobal = {};
            let setF = new Set(), setG = new Set();
            mesesDisp = {};

            for (let i = 1; i < lineas.length; i++) {
                const col = lineas[i].split(sep).map(c => c.trim());
                if (col.length < 5) continue;

                // FILTRO: Solo Activos y solo Sprinklr
                const estatus = col[iEs]?.toUpperCase() || "";
                const sistema = col[iSi]?.toUpperCase() || "";
                
                if (estatus !== "ACTIVO" || !sistema.includes("SPRINKLR")) continue; 

                const ag = col[iAg], fec = col[iDi], mesN = col[iMe]?.toUpperCase(),
                      seg = t2s(col[iHr]), ger = col[iGe] || "S/G", mesId = fec.split('/')[1];

                if (!ag || !fec) continue;
                setF.add(fec); setG.add(ger);
                if (mesId) mesesDisp[mesId] = mesN;

                if (!dataGlobal[ag]) dataGlobal[ag] = { ag, ger, logs: {} };
                if (!dataGlobal[ag].logs[fec]) dataGlobal[ag].logs[fec] = 0;
                dataGlobal[ag].logs[fec] += seg;
            }

            fechasGlobal = [...setF].sort((a,b) => a.split('/').reverse().join('').localeCompare(b.split('/').reverse().join('')));
            
            const sMes = document.getElementById('sel_mes');
            sMes.innerHTML = '<option value="ALL">PERIODO COMPLETO</option>';
            Object.keys(mesesDisp).sort().forEach(id => sMes.innerHTML += `<option value="${id}">${mesesDisp[id]}</option>`);

            const sGer = document.getElementById('sel_ger');
            sGer.innerHTML = '<option value="ALL">TODOS LOS GERENTES</option>';
            [...setG].sort().forEach(g => sGer.innerHTML += `<option value="${g}">${g}</option>`);

            document.getElementById('file_status').innerText = "‚úÖ FILTRADO POR 'ACTIVO'";
            render();
        }

        function render() {
            const mSel = document.getElementById('sel_mes').value,
                  gSel = document.getElementById('sel_ger').value,
                  q = document.getElementById('search_box').value.toUpperCase();

            const fFilt = mSel === "ALL" ? fechasGlobal : fechasGlobal.filter(f => f.split('/')[1] === mSel);
            let htmlMain = "", htmlAlerts = "", tTotal = 0, alertCount = 0;
            let timeLine = fFilt.map(() => 0);

            Object.values(dataGlobal).forEach(u => {
                if ((gSel !== "ALL" && u.ger !== gSel) || (q && !u.ag.toUpperCase().includes(q))) return;

                let uSum = 0, uOffDays = 0, boxes = "";
                
                fFilt.forEach((f, idx) => {
                    const segs = u.logs[f] || 0;
                    uSum += segs;
                    timeLine[idx] += segs;

                    if (segs === 0) uOffDays++;
                    const css = segs > 0 ? 'spr-high' : 'day-off';
                    boxes += `<div class="day-box ${css}" title="${f}">${f.split('/')[0]}</div>`;
                });

                tTotal += uSum;

                // Alertas de personal ACTIVO con m√°s de 2 d√≠as de inactividad
                if (uOffDays > 2) {
                    alertCount++;
                    htmlAlerts += `
                        <tr>
                            <td class="p-3 font-black text-slate-800">${u.ag}</td>
                            <td class="p-3 text-slate-500 uppercase font-bold">${u.ger}</td>
                            <td class="p-3 text-center text-red-600 font-black">${uOffDays} D√çAS OFF</td>
                        </tr>`;
                }

                htmlMain += `<tr>
                    <td class="p-4"><p class="font-black text-slate-800 text-[12px] uppercase">${u.ag}</p><p class="text-[9px] text-slate-400 font-bold uppercase">${u.ger}</p></td>
                    <td class="p-4 flex flex-wrap gap-1 justify-center">${boxes}</td>
                    <td class="p-4 text-right font-black text-blue-600 text-[13px]">${s2t(uSum)}</td>
                </tr>`;
            });

            document.getElementById('table_alerts').innerHTML = alertCount > 0 ? htmlAlerts : '<tr><td colspan="3" class="p-6 text-center text-emerald-500 font-bold">‚úÖ TODO EL PERSONAL ACTIVO TIENE CONEXI√ìN</td></tr>';
            document.getElementById('count_alerts').innerText = alertCount;
            document.getElementById('table_body').innerHTML = htmlMain;
            document.getElementById('total_acumulado').innerText = `TOTAL ACTIVO: ${s2t(tTotal)}`;
            
            // GR√ÅFICA CON ETIQUETAS MEJORADAS
            const valuesY = timeLine.map(v => (v/3600).toFixed(1));
            Plotly.newPlot('chart_div', [{ 
                x: fFilt.map(f => f.substring(0,5)), 
                y: valuesY, 
                type: 'scatter', 
                mode: 'lines+markers+text',
                text: valuesY.map(v => v > 0 ? v : ""), 
                textfont: { family: 'Arial Black', size: 10, color: '#1e40af' },
                textposition: 'top center',
                line: { color: '#2563eb', width: 3, shape: 'spline' },
                marker: { size: 6 }
            }], { 
                title: { text: 'CONEXI√ìN DIARIA (ACTIVOS)', font: { family: 'Arial Black', size: 14 } },
                margin: { t: 50, b: 40, l: 40, r: 20 },
                xaxis: { showgrid: false },
                yaxis: { title: 'Horas' }
            }, { responsive: true, displayModeBar: false });
        }

        document.getElementById('sel_mes').onchange = render;
        document.getElementById('sel_ger').onchange = render;
        document.getElementById('search_box').oninput = render;
    </script>
</body>
</html>
