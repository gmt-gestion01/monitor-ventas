<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT AUDIT | Auditor√≠a Operativa</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .day-box { width: 18px; height: 18px; border-radius: 3px; font-size: 7px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: bold; border: 1px solid rgba(0,0,0,0.05); }
        .spr-high { background-color: #2563eb; color: white; }
        .day-off { background-color: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .sticky-thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 20; border-bottom: 2px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-100 p-4">

    <div class="max-w-7xl mx-auto">
        <div class="bg-white p-5 rounded-2xl shadow-sm border mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-lg font-black uppercase tracking-tighter text-slate-900 italic">GMT <span class="text-blue-600">SPRINKLR</span> AUDIT</h1>
                <p id="file_status" class="text-[9px] font-bold text-slate-400 uppercase">Esperando archivo CSV...</p>
            </div>
            <div class="flex gap-2">
                <input type="file" id="csv_input" accept=".csv" class="hidden">
                <button onclick="document.getElementById('csv_input').click()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-md hover:bg-slate-800 transition-all">üìÇ Cargar Archivo</button>
                <select id="sel_mes" class="bg-white text-slate-700 text-[10px] font-black px-4 py-2 rounded-xl border outline-none cursor-pointer"></select>
            </div>
        </div>

        <div class="bg-white p-4 rounded-2xl border mb-4 shadow-sm">
            <div id="chart_div" style="height: 300px;"></div>
        </div>

        <div class="mb-4">
            <div class="bg-white rounded-2xl border shadow-sm overflow-hidden border-red-100">
                <div class="bg-red-600 p-3 flex justify-between items-center">
                    <h2 class="text-white font-black text-[10px] uppercase tracking-widest italic">‚ö†Ô∏è Alertas de Inactividad Cr√≠tica (Cr√≠ticos primero)</h2>
                    <span id="count_alerts" class="bg-white text-red-600 text-[10px] px-2 py-0.5 rounded font-black">0</span>
                </div>
                <div class="max-h-48 overflow-y-auto">
                    <table class="w-full text-left text-[11px]">
                        <tbody id="table_alerts" class="divide-y divide-red-50 italic"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="w-full md:w-auto flex flex-1 gap-2">
                    <input type="text" id="search_box" placeholder="BUSCAR AGENTE..." class="w-full max-w-xs px-4 py-2 text-[10px] border rounded-lg outline-none font-bold uppercase focus:ring-2 focus:ring-blue-500/20">
                    <select id="sel_ger" class="w-full max-w-xs bg-white text-slate-700 text-[10px] font-black px-4 py-2 rounded-lg border outline-none cursor-pointer"></select>
                </div>
                <div class="text-right">
                    <p id="total_acumulado" class="text-lg font-black text-blue-600 leading-none"></p>
                    <p class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter italic">Acumulado Activos</p>
                </div>
            </div>
            
            <div class="overflow-x-auto max-h-[600px]">
                <table class="w-full text-left text-[11px]">
                    <thead class="sticky-thead bg-slate-50 text-slate-500 font-bold uppercase">
                        <tr>
                            <th class="p-4">Ejecutivo / Gerencia</th>
                            <th class="p-4 text-center">Calendario</th>
                            <th class="p-4 text-center">D√≠as Conectado</th>
                            <th class="p-4 text-right">Total Horas (Menor a Mayor)</th>
                        </tr>
                    </thead>
                    <tbody id="table_body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataGlobal = {}, fechasGlobal = [], mesesDisp = {};

        document.getElementById('csv_input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { procesarCSV(e.target.result); };
            reader.readAsText(file);
        });

        function t2s(t) {
            if (!t) return 0;
            const p = t.toString().split(':');
            return p.length < 2 ? 0 : (+p[0] * 3600) + (+p[1] * 60) + (+p[2] || 0);
        }

        function s2t(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return `${h}:${m.toString().padStart(2, '0')}`;
        }

        function procesarCSV(csv) {
            const lineas = csv.split(/\r?\n/).filter(l => l.trim().length > 10);
            const sep = lineas[0].includes(';') ? ';' : ',';
            const cab = lineas[0].split(sep).map(h => h.trim().toUpperCase());
            
            const iAg = cab.indexOf("AGENTE"), iHr = cab.indexOf("HORAS LOGUEO"),
                  iDi = cab.indexOf("DIA"), iMe = cab.indexOf("MES"),
                  iSi = cab.indexOf("SISTEMA"), iGe = cab.indexOf("GERENCIA"),
                  iEs = cab.indexOf("ESTATUS");

            dataGlobal = {};
            let setF = new Set(), setG = new Set();
            mesesDisp = {};

            for (let i = 1; i < lineas.length; i++) {
                const col = lineas[i].split(sep).map(c => c.trim());
                if (col.length < 5) continue;
                if ((col[iEs]?.toUpperCase() || "") !== "ACTIVO" || !(col[iSi]?.toUpperCase() || "").includes("SPRINKLR")) continue; 

                const ag = col[iAg], fec = col[iDi], mesN = col[iMe]?.toUpperCase(),
                      seg = t2s(col[iHr]), ger = col[iGe] || "S/G", mesId = fec.split('/')[1];

                if (!ag || !fec) continue;
                setF.add(fec); setG.add(ger);
                if (mesId) mesesDisp[mesId] = mesN;

                if (!dataGlobal[ag]) dataGlobal[ag] = { ag, ger, logs: {} };
                if (!dataGlobal[ag].logs[fec]) dataGlobal[ag].logs[fec] = 0;
                dataGlobal[ag].logs[fec] += seg;
            }

            fechasGlobal = [...setF].sort((a,b) => a.split('/').reverse().join('').localeCompare(b.split('/').reverse().join('')));
            
            const sMes = document.getElementById('sel_mes');
            sMes.innerHTML = '<option value="ALL">VISTA MENSUAL ACUMULADA</option>';
            Object.keys(mesesDisp).sort().forEach(id => sMes.innerHTML += `<option value="${id}">${mesesDisp[id]}</option>`);

            const sGer = document.getElementById('sel_ger');
            sGer.innerHTML = '<option value="ALL">TODAS LAS GERENCIAS</option>';
            [...setG].sort().forEach(g => sGer.innerHTML += `<option value="${g}">${g}</option>`);

            document.getElementById('file_status').innerText = "‚úÖ ARCHIVO CARGADO CORRECTAMENTE";
            render();
        }

        function render() {
            const mSel = document.getElementById('sel_mes').value,
                  gSel = document.getElementById('sel_ger').value,
                  q = document.getElementById('search_box').value.toUpperCase();

            const fFilt = mSel === "ALL" ? fechasGlobal : fechasGlobal.filter(f => f.split('/')[1] === mSel);
            let listAgentes = [];
            let timeLine = fFilt.map(() => 0);

            Object.values(dataGlobal).forEach(u => {
                if ((gSel !== "ALL" && u.ger !== gSel) || (q && !u.ag.toUpperCase().includes(q))) return;

                let uSum = 0, uOff = 0, uOn = 0, boxes = "";
                fFilt.forEach((f, idx) => {
                    const s = u.logs[f] || 0;
                    uSum += s;
                    timeLine[idx] += s;
                    if (s === 0) uOff++; else uOn++;
                    const css = s > 0 ? 'spr-high' : 'day-off';
                    boxes += `<div class="day-box ${css}">${f.split('/')[0]}</div>`;
                });

                if (uSum > 0 || uOff > 0) {
                    listAgentes.push({ ...u, currentSum: uSum, currentOff: uOff, currentOn: uOn, boxes });
                }
            });

            // --- ORDENACIONES ---
            // Tabla Principal: MENOR TIEMPO PRIMERO (A-B)
            const sortedGeneral = [...listAgentes].sort((a, b) => a.currentSum - b.currentSum);
            // Alertas: MAYOR INACTIVIDAD PRIMERO (B-A)
            const sortedAlerts = [...listAgentes].filter(a => a.currentOff > 2 && a.currentSum > 0).sort((a, b) => b.currentOff - a.currentOff);

            document.getElementById('count_alerts').innerText = `${sortedAlerts.length} AGENTES EN RIESGO`;
            document.getElementById('table_alerts').innerHTML = sortedAlerts.map(u => `
                <tr class="border-b border-red-50">
                    <td class="p-2 font-black text-slate-800 uppercase pl-4">${u.ag}</td>
                    <td class="p-2 text-slate-400 font-bold text-[9px] uppercase">${u.ger}</td>
                    <td class="p-2 text-right text-red-600 font-black pr-4">${u.currentOff} D√çAS SIN CONEXI√ìN</td>
                </tr>`).join('');

            let tTotal = 0;
            document.getElementById('table_body').innerHTML = sortedGeneral.map(u => {
                tTotal += u.currentSum;
                return `<tr>
                    <td class="p-4"><p class="font-black text-slate-800 uppercase">${u.ag}</p><p class="text-[9px] text-slate-400 font-bold uppercase">${u.ger}</p></td>
                    <td class="p-4 flex flex-wrap gap-1 justify-center">${u.boxes}</td>
                    <td class="p-4 text-center font-bold text-slate-600 text-sm">${u.currentOn} <span class="text-[9px] text-slate-400 font-normal italic">d√≠as</span></td>
                    <td class="p-4 text-right font-black text-blue-600 text-sm">${s2t(u.currentSum)}</td>
                </tr>`;
            }).join('');

            document.getElementById('total_acumulado').innerText = s2t(tTotal);
            
            // GR√ÅFICA CON ETIQUETAS
            const valuesY = timeLine.map(v => (v/3600).toFixed(1));
            Plotly.newPlot('chart_div', [{ 
                x: fFilt.map(f => f.substring(0,5)), y: valuesY, type: 'scatter', mode: 'lines+markers+text',
                text: valuesY.map(v => v > 0 ? v : ""), 
                textfont: { family: 'Arial Black', size: 10, color: '#2563eb' },
                textposition: 'top center',
                line: { color: '#2563eb', width: 3 },
                marker: { size: 6 }
            }], { 
                title: { text: 'EVOLUCI√ìN DE HORAS LOGUEO', font: { family: 'Arial Black', size: 12 } },
                margin: { t: 50, b: 40, l: 40, r: 20 },
                xaxis: { showgrid: false },
                yaxis: { title: 'Horas' }
            }, { responsive: true, displayModeBar: false });
        }

        document.getElementById('sel_mes').onchange = render;
        document.getElementById('sel_ger').onchange = render;
        document.getElementById('search_box').oninput = render;
    </script>
</body>
</html>
