<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT CONTROL | Sprinklr Audit</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .day-box { width: 22px; height: 22px; border-radius: 4px; font-size: 9px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: bold; border: 1px solid rgba(0,0,0,0.05); }
        .spr-high { background-color: #2563eb; color: white; }
        .day-off { background-color: #f1f5f9; color: #cbd5e1; }
        .sticky-thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; border-bottom: 2px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-sm border mb-6 flex flex-col lg:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-black uppercase tracking-tighter text-slate-900">GMT <span class="text-blue-600">SPRINKLR</span></h1>
                <p id="file_status" class="text-[10px] font-bold text-red-500 uppercase">Cargar archivo HORAS_ACUMULADO_HC_1.csv</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-2">
                <input type="file" id="csv_input" accept=".csv" class="hidden">
                <button onclick="document.getElementById('csv_input').click()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-md hover:bg-blue-700 transition-all">ðŸ“‚ Cargar CSV</button>
                
                <select id="sel_mes" class="bg-white text-slate-700 text-[10px] font-black px-4 py-2 rounded-xl border outline-none cursor-pointer"></select>
                <select id="sel_ger" class="bg-white text-slate-700 text-[10px] font-black px-4 py-2 rounded-xl border outline-none cursor-pointer"></select>
                <select id="sel_area" class="bg-white text-slate-700 text-[10px] font-black px-4 py-2 rounded-xl border outline-none cursor-pointer"></select>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border mb-6 shadow-sm">
            <div id="chart_div" style="height: 400px;"></div>
        </div>

        <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                <input type="text" id="search_box" placeholder="BUSCAR AGENTE..." class="w-full max-w-sm px-4 py-2 text-xs border rounded-lg outline-none font-bold uppercase focus:ring-2 focus:ring-blue-500/20">
                <div class="flex items-center gap-4">
                    <p id="total_acumulado" class="text-xs font-black text-blue-600 uppercase"></p>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[600px]">
                <table class="w-full text-left text-[11px]">
                    <thead class="sticky-thead bg-slate-50 text-slate-500 font-bold uppercase">
                        <tr>
                            <th class="p-4">Agente / Gerencia</th>
                            <th class="p-4 text-center">Actividad Diaria (Sprinklr)</th>
                            <th class="p-4 text-right">Total Horas</th>
                        </tr>
                    </thead>
                    <tbody id="table_body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataGlobal = {}, fechasGlobal = [], mesesDisp = {}, gersDisp = {}, areasDisp = {};

        document.getElementById('csv_input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { procesarCSV(e.target.result); };
            reader.readAsText(file);
        });

        function t2s(t) {
            if (!t) return 0;
            const p = t.toString().split(':');
            return p.length < 2 ? 0 : (+p[0] * 3600) + (+p[1] * 60) + (+p[2] || 0);
        }

        function s2t(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return `${h}:${m.toString().padStart(2, '0')}`;
        }

        function procesarCSV(csv) {
            const lineas = csv.split(/\r?\n/).filter(l => l.trim().length > 10);
            const sep = lineas[0].includes(';') ? ';' : ',';
            const cab = lineas[0].split(sep).map(h => h.trim().toUpperCase());
            
            const iAg = cab.indexOf("AGENTE"), iHr = cab.indexOf("HORAS LOGUEO"),
                  iDi = cab.indexOf("DIA"), iMe = cab.indexOf("MES"),
                  iSi = cab.indexOf("SISTEMA"), iAr = cab.indexOf("AREA"),
                  iGe = cab.indexOf("GERENCIA");

            dataGlobal = {};
            let setF = new Set(), setA = new Set(), setG = new Set();
            mesesDisp = {};

            for (let i = 1; i < lineas.length; i++) {
                const col = lineas[i].split(sep).map(c => c.trim());
                if (col.length < 5) continue;

                const sis = col[iSi]?.toUpperCase() || "";
                if (!sis.includes("SPRINKLR")) continue; // FILTRO SOLO SPRINKLR

                const ag = col[iAg], fec = col[iDi], mesN = col[iMe]?.toUpperCase(),
                      seg = t2s(col[iHr]), area = col[iAr] || "S/A", 
                      ger = col[iGe] || "SIN GERENCIA", mesId = fec.split('/')[1];

                if (!ag || !fec) continue;
                setF.add(fec); setA.add(area); setG.add(ger);
                if (mesId) mesesDisp[mesId] = mesN;

                if (!dataGlobal[ag]) dataGlobal[ag] = { ag, area, ger, logs: {} };
                if (!dataGlobal[ag].logs[fec]) dataGlobal[ag].logs[fec] = 0;
                dataGlobal[ag].logs[fec] += seg;
            }

            fechasGlobal = [...setF].sort((a,b) => a.split('/').reverse().join('').localeCompare(b.split('/').reverse().join('')));
            
            // Llenar Selectores
            const fillSel = (id, data, label) => {
                const s = document.getElementById(id);
                s.innerHTML = `<option value="ALL">${label}</option>`;
                [...data].sort().forEach(v => {
                    const val = typeof v === 'object' ? v.id : v;
                    const txt = typeof v === 'object' ? v.txt : v;
                    s.innerHTML += `<option value="${val}">${txt}</option>`;
                });
            };

            fillSel('sel_mes', Object.keys(mesesDisp).map(k => ({id: k, txt: mesesDisp[k]})), 'TODOS LOS MESES');
            fillSel('sel_ger', setG, 'TODAS LAS GERENCIAS');
            fillSel('sel_area', setA, 'TODAS LAS AREAS');

            document.getElementById('file_status').innerText = "âœ… ARCHIVO CARGADO";
            document.getElementById('file_status').className = "text-[10px] font-bold text-emerald-500 uppercase";
            render();
        }

        function render() {
            const mSel = document.getElementById('sel_mes').value,
                  gSel = document.getElementById('sel_ger').value,
                  aSel = document.getElementById('sel_area').value,
                  q = document.getElementById('search_box').value.toUpperCase();

            const fFilt = mSel === "ALL" ? fechasGlobal : fechasGlobal.filter(f => f.split('/')[1] === mSel);
            let html = "", tTotal = 0;
            let timeLine = fFilt.map(() => 0);

            Object.values(dataGlobal).forEach(u => {
                if ((gSel !== "ALL" && u.ger !== gSel) || 
                    (aSel !== "ALL" && u.area !== aSel) || 
                    (q && !u.ag.toUpperCase().includes(q))) return;

                let uSum = 0, boxes = "";
                fFilt.forEach((f, idx) => {
                    const segs = u.logs[f] || 0;
                    uSum += segs;
                    timeLine[idx] += segs;

                    const css = segs > 0 ? 'spr-high' : 'day-off';
                    boxes += `<div class="day-box ${css}" title="${f}: ${s2t(segs)}">${f.split('/')[0]}</div>`;
                });

                tTotal += uSum;
                html += `<tr>
                    <td class="p-4 font-black text-slate-800">${u.ag}<br><span class="text-[9px] text-slate-400 font-bold uppercase">${u.ger} | ${u.area}</span></td>
                    <td class="p-4 flex flex-wrap gap-1 justify-center">${boxes}</td>
                    <td class="p-4 text-right font-black text-blue-600 text-sm">${s2t(uSum)}</td>
                </tr>`;
            });

            document.getElementById('table_body').innerHTML = html;
            document.getElementById('total_acumulado').innerText = `Total Sprinklr: ${s2t(tTotal)}`;
            
            // GRÃFICO CON ETIQUETAS FORZADAS
            const valuesY = timeLine.map(v => (v/3600).toFixed(1));
            
            Plotly.newPlot('chart_div', [{ 
                x: fFilt.map(f => f.substring(0,5)), 
                y: valuesY, 
                name: 'Horas Sprinklr', 
                type: 'scatter', 
                mode: 'lines+markers+text', // ACTIVADO
                text: valuesY.map(v => v > 0 ? v : ""), // ETIQUETAS
                textposition: 'top center',
                textfont: { family: 'Arial Black', size: 10, color: '#1e40af' },
                line: { color: '#2563eb', width: 4, shape: 'spline' },
                marker: { size: 8, color: '#1e40af' }
            }], { 
                title: { text: 'CONEXIÃ“N DIARIA SPRINKLR (HORAS)', font: { family: 'Arial Black', size: 14 } },
                margin: { t: 60, b: 40, l: 50, r: 20 },
                xaxis: { showgrid: false },
                yaxis: { title: 'Horas', gridcolor: '#f1f5f9' }
            }, { responsive: true, displayModeBar: false });
        }

        // Eventos
        ['sel_mes', 'sel_ger', 'sel_area'].forEach(id => {
            document.getElementById(id).onchange = render;
        });
        document.getElementById('search_box').oninput = render;
    </script>
</body>
</html>
