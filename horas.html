<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMT MONITOR | Sincronizaci贸n Total</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .day-box { width: 14px; height: 14px; border-radius: 2px; font-size: 7px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 1px; }
        .is-active { background-color: #2563eb; color: white; }
        .is-off { background-color: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .scroll-custom::-webkit-scrollbar { width: 6px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-[1400px] mx-auto">
        <div class="flex flex-col md:flex-row gap-4 mb-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border-t-4 border-blue-600 flex-1">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xs font-black uppercase tracking-widest text-slate-500">Estado de <span class="text-blue-600">Sincronizaci贸n</span></h2>
                    <span id="sync-status" class="text-[9px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded-full uppercase">Cargando...</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-[10px] font-bold text-slate-400">AGENTE ACTIVO</p><p id="kpi-ejes" class="text-4xl font-black text-slate-800">0</p></div>
                    <div><p class="text-[10px] font-bold text-slate-400">HORAS TOTALES</p><p id="kpi-hrs" class="text-4xl font-black text-blue-600">0:00</p></div>
                </div>
            </div>
            
            <div id="alert-card" class="bg-white p-6 rounded-3xl shadow-sm border-t-4 border-red-500 flex-1">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[10px] font-black text-red-500 uppercase tracking-widest"> Alertas de Inasistencia</p>
                    <span id="alert-count" class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-black">0</span>
                </div>
                <div id="alert-list" class="max-h-[80px] overflow-y-auto text-[11px] text-slate-600 scroll-custom">
                    Buscando agentes con faltas...
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <select id="sel-mes" class="p-3 rounded-2xl border-none shadow-sm font-bold text-xs bg-white outline-none ring-1 ring-slate-200"></select>
            <select id="sel-dia" class="p-3 rounded-2xl border-none shadow-sm font-bold text-xs bg-white outline-none ring-1 ring-slate-200"></select>
            <select id="sel-ger" class="p-3 rounded-2xl border-none shadow-sm font-bold text-xs bg-white outline-none ring-1 ring-slate-200"></select>
        </div>

        <div class="bg-white rounded-3xl border shadow-sm overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                <p class="text-[10px] font-black text-slate-400 uppercase">Detalle de Conexi贸n y Calendario</p>
                <button onclick="location.reload()" class="text-[9px] font-bold bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded-lg uppercase">Forzar Refresco</button>
            </div>
            <div class="overflow-x-auto max-h-[600px] scroll-custom">
                <table class="w-full text-left">
                    <thead class="bg-white text-[10px] text-slate-400 font-black uppercase sticky top-0 z-20 border-b">
                        <tr>
                            <th class="p-5">Agente / Usuario</th>
                            <th class="p-5">Gerencia</th>
                            <th class="p-5 text-center">Actividad (ltimos 15 d铆as)</th>
                            <th class="p-5 text-right">Total Acumulado</th>
                        </tr>
                    </thead>
                    <tbody id="main-table" class="divide-y divide-slate-100 text-[12px]"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_URL = "https://raw.githubusercontent.com/gmt-gestion01/monitor-ventas/main/HORAS_ACUMULADO_HC_1.csv";
        let db = [];
        let allDates = [];

        async function start() {
            try {
                // Sincronizaci贸n real rompiendo cach茅
                const r = await fetch(`${GITHUB_URL}?nocache=${Date.now()}`);
                const txt = await r.text();
                const lines = txt.replace(/^\uFEFF/, "").split(/\r?\n/).filter(l => l.trim() !== "");
                
                const h = lines[0].toUpperCase().split(',').map(s => s.trim());
                const col = {
                    ag: h.indexOf("AGENTE"),
                    us: h.indexOf("USUARIO"),
                    hr: h.indexOf("HORAS"),
                    ge: h.indexOf("GERENCIA"),
                    fe: h.indexOf("FECHA"),
                    me: h.indexOf("MES")
                };

                db = lines.slice(1).map(line => {
                    const c = line.split(',').map(v => v.trim());
                    
                    // PARSEO DE HORAS ULTRA FLEXIBLE (Soporta 7:00:00 y 07:00:00)
                    const parts = (c[col.hr] || "0:0:0").split(':');
                    const segs = (parseInt(parts[0]) * 3600) + (parseInt(parts[1]) * 60) + (parseInt(parts[2] || 0));

                    return {
                        agente: c[col.ag] || "S/N",
                        usuario: c[col.us] || "S/U",
                        segundos: isNaN(segs) ? 0 : segs,
                        gerencia: (c[col.ge] || "GENERAL").toUpperCase(),
                        fecha: c[col.fe] || "",
                        mes: (c[col.me] || "").toLowerCase()
                    };
                }).filter(i => i.fecha !== "");

                // Ordenar fechas cronol贸gicamente
                allDates = [...new Set(db.map(d => d.fecha))].sort((a,b) => {
                    const [da, ma, aa] = a.split('/');
                    return new Date(aa, ma-1, da) - new Date(b.split('/')[2], b.split('/')[1]-1, b.split('/')[0]);
                });

                document.getElementById('sync-status').innerText = `D铆a de Corte: ${allDates[allDates.length-1]}`;
                setupFilters();
                render();
            } catch (e) { console.error(e); }
        }

        function setupFilters() {
            const m = [...new Set(db.map(i => i.mes))].sort();
            const g = [...new Set(db.map(i => i.gerencia))].sort();
            document.getElementById('sel-mes').innerHTML = '<option value="ALL">TODOS LOS MESES</option>' + m.map(x => `<option value="${x}">${x.toUpperCase()}</option>`).join('');
            document.getElementById('sel-ger').innerHTML = '<option value="ALL">TODAS LAS GERENCIAS</option>' + g.map(x => `<option value="${x}">${x}</option>`).join('');
            const selM = document.getElementById('sel-mes').value;
            const days = allDates.filter(f => db.find(r => r.fecha === f && (selM === 'ALL' || r.mes === selM)));
            document.getElementById('sel-dia').innerHTML = '<option value="ALL">TODOS LOS DAS</option>' + days.map(f => `<option value="${f}">${f}</option>`).join('');
        }

        function render() {
            const fM = document.getElementById('sel-mes').value;
            const fD = document.getElementById('sel-dia').value;
            const fG = document.getElementById('sel-ger').value;

            const filtered = db.filter(r => (fM === 'ALL' || r.mes === fM) && (fD === 'ALL' || r.fecha === fD) && (fG === 'ALL' || r.gerencia === fG));
            const range = allDates.filter(f => db.find(r => r.fecha === f && (fM === 'ALL' || r.mes === fM)));

            let ag = {};
            filtered.forEach(r => {
                if(!ag[r.usuario]) ag[r.usuario] = { n: r.agente, u: r.usuario, g: r.gerencia, t: 0, d: new Set() };
                ag[r.usuario].t += r.segundos;
                ag[r.usuario].d.add(r.fecha);
            });

            // L贸gica de Alertas
            const alertas = Object.values(ag).filter(a => a.d.size < range.length);
            document.getElementById('alert-count').innerText = alertas.length;
            document.getElementById('alert-list').innerHTML = alertas.length > 0 ? 
                alertas.slice(0, 10).map(a => `<p>锔 <b>${a.n}</b> (Faltan ${range.length - a.d.size} d铆as)</p>`).join('') : "No hay alertas.";

            document.getElementById('kpi-hrs').innerText = `${Math.floor(filtered.reduce((a,b)=>a+b.segundos,0)/3600)}h`;
            document.getElementById('kpi-ejes').innerText = Object.keys(ag).length;

            document.getElementById('main-table').innerHTML = Object.values(ag).sort((a,b) => b.t - a.t).map(s => {
                let bxs = "";
                range.slice(-15).forEach(f => {
                    bxs += `<div class="day-box ${s.d.has(f) ? 'is-active' : 'is-off'}">${f.split('/')[0]}</div>`;
                });
                const h = Math.floor(s.t / 3600);
                const min = Math.floor((s.t % 3600) / 60);
                return `<tr>
                    <td class="p-5"><span class="font-bold text-slate-800">${s.n}</span><br><span class="text-[9px] text-blue-500 font-black">${s.u}</span></td>
                    <td class="p-5 text-[10px] font-bold text-slate-400 uppercase">${s.g}</td>
                    <td class="p-5 flex justify-center">${bxs}</td>
                    <td class="p-5 text-right font-black text-blue-600">${h}h ${min}m</td>
                </tr>`;
            }).join('');
        }

        document.getElementById('sel-mes').onchange = () => { setupFilters(); render(); };
        document.getElementById('sel-dia').onchange = render;
        document.getElementById('sel-ger').onchange = render;

        start();
    </script>
</body>
</html>
