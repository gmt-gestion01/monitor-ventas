<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMT MONITOR | Live Sync</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .day-box { width: 14px; height: 14px; border-radius: 2px; font-size: 7px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 1px; }
        .is-active { background-color: #2563eb; color: white; }
        .is-off { background-color: #f1f5f9; color: #cbd5e1; border: 1px solid #e2e8f0; }
        .scroll-custom::-webkit-scrollbar { width: 4px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-[1400px] mx-auto">
        <div class="flex flex-col md:flex-row gap-4 mb-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border-t-4 border-blue-600 flex-1">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="bg-blue-600 px-3 py-1 rounded-lg text-white font-black italic text-xl">GMT</div>
                        <h2 class="text-[10px] font-black uppercase tracking-widest">Performance <span class="text-blue-600">Real-Time</span></h2>
                    </div>
                    <span id="last-update" class="text-[9px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full uppercase">Sincronizando...</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Ejecutivos</p>
                        <p id="kpi-ejes" class="text-4xl font-black text-slate-800">0</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Horas Totales</p>
                        <p id="kpi-hrs" class="text-4xl font-black text-blue-600">0:00</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-slate-900 p-6 rounded-3xl shadow-xl flex-[0.8] text-white">
                <p class="text-[10px] font-bold text-blue-400 uppercase mb-4 tracking-widest">Filtros Activos</p>
                <div class="grid grid-cols-1 gap-3">
                    <select id="sel-mes" class="bg-slate-800 border-none p-3 rounded-xl font-bold text-xs cursor-pointer focus:ring-2 focus:ring-blue-500"></select>
                    <select id="sel-dia" class="bg-slate-800 border-none p-3 rounded-xl font-bold text-xs cursor-pointer focus:ring-2 focus:ring-blue-500"></select>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-3xl border shadow-sm mb-4">
            <div id="main-chart" style="width:100%; height:220px;"></div>
        </div>

        <div class="bg-white rounded-3xl border shadow-sm overflow-hidden">
            <div class="p-4 border-b bg-slate-50 flex flex-col md:flex-row gap-4 justify-between">
                <select id="sel-ger" class="w-full md:w-72 p-3 border rounded-xl font-bold text-xs uppercase bg-white shadow-sm outline-none"></select>
                <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-blue-700 transition-all">Refrescar Ahora</button>
            </div>
            <div class="overflow-x-auto max-h-[600px] scroll-custom">
                <table class="w-full text-left">
                    <thead class="bg-slate-100 text-[10px] text-slate-500 font-black uppercase sticky top-0 z-10">
                        <tr>
                            <th class="p-5">Agente</th>
                            <th class="p-5">Gerencia</th>
                            <th class="p-5 text-center">Calendario</th>
                            <th class="p-5 text-right">Acumulado</th>
                        </tr>
                    </thead>
                    <tbody id="main-table" class="divide-y divide-slate-100 text-[12px]"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // URL con generador de números aleatorios para evitar el caché
        const URL_BASE = "https://raw.githubusercontent.com/gmt-gestion01/monitor-ventas/main/HORAS_ACUMULADO_HC_1.csv";
        let db = [];
        let allDates = [];

        async function init() {
            try {
                // Paso 1: Engañar al caché con un parámetro único de tiempo
                const antiCacheUrl = `${URL_BASE}?v=${new Date().getTime()}`;
                const res = await fetch(antiCacheUrl);
                const rawText = await res.text();
                
                // Paso 2: Limpiar y parsear
                const rows = rawText.replace(/^\uFEFF/, "").split(/\r?\n/).filter(line => line.trim() !== "");
                const head = rows[0].toUpperCase().split(',').map(h => h.trim());
                
                const map = {
                    ag: head.indexOf("AGENTE"),
                    us: head.indexOf("USUARIO"),
                    hr: head.indexOf("HORAS"),
                    ge: head.indexOf("GERENCIA"),
                    fe: head.indexOf("FECHA"),
                    me: head.indexOf("MES")
                };

                db = rows.slice(1).map(row => {
                    const c = row.split(',').map(v => v.trim());
                    return {
                        agente: c[map.ag],
                        usuario: c[map.us],
                        segundos: timeToSec(c[map.hr]),
                        gerencia: (c[map.ge] || "SIN GERENCIA").toUpperCase(),
                        fecha: c[map.fe],
                        mes: (c[map.me] || "").toLowerCase()
                    };
                }).filter(i => i.fecha);

                // Paso 3: Configurar UI
                allDates = [...new Set(db.map(d => d.fecha))].sort((a,b) => {
                    const [da, ma, aa] = a.split('/');
                    const [db, mb, ab] = b.split('/');
                    return new Date(aa, ma-1, da) - new Date(ab, mb-1, db);
                });

                document.getElementById('last-update').innerText = `Corte: ${allDates[allDates.length-1]}`;
                
                fillSelects();
                render();
            } catch (err) {
                console.error("Error cargando datos:", err);
                document.getElementById('last-update').innerText = "Error de conexión";
            }
        }

        function timeToSec(str) {
            if (!str || str === "0") return 0;
            const p = str.split(':');
            return (parseInt(p[0]) * 3600) + (parseInt(p[1]) * 60) + (parseInt(p[2] || 0));
        }

        function secToTime(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return `${h}:${m.toString().padStart(2, '0')}`;
        }

        function fillSelects() {
            const meses = [...new Set(db.map(i => i.mes))].sort();
            const gers = [...new Set(db.map(i => i.gerencia))].sort();

            const selMes = document.getElementById('sel-mes');
            selMes.innerHTML = '<option value="ALL">TODOS LOS MESES</option>' + 
                meses.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');

            const selGer = document.getElementById('sel-ger');
            selGer.innerHTML = '<option value="ALL">TODAS LAS GERENCIAS</option>' + 
                gers.map(g => `<option value="${g}">${g}</option>`).join('');
            
            updateDaySelect();
        }

        function updateDaySelect() {
            const m = document.getElementById('sel-mes').value;
            const filteredDays = allDates.filter(f => db.find(r => r.fecha === f && (m === 'ALL' || r.mes === m)));
            document.getElementById('sel-dia').innerHTML = '<option value="ALL">TODOS LOS DÍAS</option>' + 
                filteredDays.map(f => `<option value="${f}">${f}</option>`).join('');
        }

        function render() {
            const fMes = document.getElementById('sel-mes').value;
            const fDia = document.getElementById('sel-dia').value;
            const fGer = document.getElementById('sel-ger').value;

            const filtered = db.filter(r => 
                (fMes === 'ALL' || r.mes === fMes) && 
                (fDia === 'ALL' || r.fecha === fDia) && 
                (fGer === 'ALL' || r.gerencia === fGer)
            );

            const activeRange = allDates.filter(f => db.find(r => r.fecha === f && (fMes === 'ALL' || r.mes === fMes)));

            let summary = {}, trend = {};
            activeRange.forEach(d => trend[d] = 0);

            filtered.forEach(r => {
                if(!summary[r.usuario]) summary[r.usuario] = { n: r.agente, u: r.usuario, g: r.gerencia, t: 0, d: new Set() };
                summary[r.usuario].t += r.segundos;
                summary[r.usuario].d.add(r.fecha);
                if(trend[r.fecha] !== undefined) trend[r.fecha] += r.segundos;
            });

            // KPIs
            document.getElementById('kpi-hrs').innerText = secToTime(filtered.reduce((a,b) => a + b.segundos, 0));
            document.getElementById('kpi-ejes').innerText = Object.keys(summary).length;

            // Table
            document.getElementById('main-table').innerHTML = Object.values(summary).sort((a,b) => b.t - a.t).map(s => {
                let boxes = "";
                activeRange.slice(-14).forEach(f => { // Ultimas 2 semanas
                    boxes += `<div class="day-box ${s.d.has(f) ? 'is-active' : 'is-off'}">${f.split('/')[0]}</div>`;
                });
                return `<tr>
                    <td class="p-5"><span class="font-bold text-slate-800">${s.n}</span><br><span class="text-[9px] font-black text-blue-500">${s.u}</span></td>
                    <td class="p-5 text-[10px] font-bold text-slate-400 uppercase">${s.g}</td>
                    <td class="p-5 flex justify-center items-center">${boxes}</td>
                    <td class="p-5 text-right font-black text-blue-600 text-sm">${secToTime(s.t)}</td>
                </tr>`;
            }).join('');

            drawChart(trend);
        }

        function drawChart(data) {
            const trace = {
                x: Object.keys(data),
                y: Object.values(data).map(s => (s/3600).toFixed(1)),
                type: 'scatter', mode: 'lines+markers',
                line: { shape: 'spline', color: '#2563eb', width: 4 },
                fill: 'tozeroy', fillcolor: 'rgba(37, 99, 235, 0.05)'
            };
            Plotly.newPlot('main-chart', [trace], {
                margin: { t: 10, b: 30, l: 40, r: 10 },
                xaxis: { showgrid: false, tickfont: { size: 9, color: '#94a3b8' } },
                yaxis: { gridcolor: '#f1f5f9', tickfont: { size: 9, color: '#94a3b8' } }
            }, {responsive: true, displayModeBar: false});
        }

        document.getElementById('sel-mes').addEventListener('change', () => { updateDaySelect(); render(); });
        document.getElementById('sel-dia').addEventListener('change', render);
        document.getElementById('sel-ger').addEventListener('change', render);

        init();
    </script>
</body>
</html>
