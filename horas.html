<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT CONTROL | Auditoría HC</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .day-box { width: 20px; height: 20px; border-radius: 4px; font-size: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: bold; border: 1px solid rgba(0,0,0,0.05); }
        .spr-high { background-color: #2563eb; color: white; }
        .vic-high { background-color: #f97316; color: white; }
        .day-off { background-color: #f1f5f9; color: #cbd5e1; }
        .sticky-thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; border-bottom: 2px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="bg-white p-6 rounded-xl shadow-sm border mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-black uppercase tracking-tighter">GMT <span class="text-blue-600">AUDIT</span> | <span id="txt_mes_actual">PANEL GENERAL</span></h1>
                <p id="status_file" class="text-[10px] font-bold text-red-500 uppercase italic">Esperando archivo...</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <select id="f_mes" class="bg-blue-50 text-blue-700 text-[10px] font-black px-4 py-2 rounded-lg border border-blue-100 outline-none"></select>
                <select id="f_area" class="bg-emerald-50 text-emerald-700 text-[10px] font-black px-4 py-2 rounded-lg border border-emerald-100 outline-none"></select>
                <button onclick="generarExcel()" class="bg-slate-900 text-white px-5 py-2 rounded-lg text-[10px] font-black shadow-md uppercase">Excel</button>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
            <div class="bg-white p-4 rounded-xl border"><p class="text-[9px] font-bold text-slate-400 uppercase">Sprinklr</p><p id="k_spr" class="text-lg font-black text-blue-600">0:00</p></div>
            <div class="bg-white p-4 rounded-xl border"><p class="text-[9px] font-bold text-slate-400 uppercase">Vicidial</p><p id="k_vic" class="text-lg font-black text-orange-500">0:00</p></div>
            <div class="bg-white p-4 rounded-xl border"><p class="text-[9px] font-bold text-slate-400 uppercase">Días Periodo</p><p id="k_dias" class="text-lg font-black">0</p></div>
            <div class="bg-white p-4 rounded-xl border"><p class="text-[9px] font-bold text-slate-400 uppercase italic text-red-500">Alertas</p><p id="k_alert" class="text-lg font-black text-red-600">0</p></div>
        </div>

        <div class="bg-white p-4 rounded-xl border shadow-sm mb-6"><div id="g_linea" style="height: 300px;"></div></div>

        <div class="bg-white rounded-xl border shadow-sm overflow-hidden">
            <div class="p-4 bg-slate-50 border-b"><input type="text" id="busqueda" placeholder="BUSCAR AGENTE..." class="w-full max-w-sm px-4 py-2 text-xs border rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 uppercase font-bold"></div>
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                <table class="w-full text-left text-[10px]">
                    <thead class="sticky-thead uppercase font-bold text-slate-500 bg-slate-50">
                        <tr><th class="p-4">Agente / Datos</th><th class="p-4 text-center">Mapa de Conexión</th><th class="p-4 text-right">Total</th></tr>
                    </thead>
                    <tbody id="t_body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataGlobal = {};
        let fechasGlobal = [];
        let mesesRef = {};

        window.onload = () => cargarCSV();

        async function cargarCSV() {
            const fileName = 'HORAS_ACUMULADO_HC_1.csv';
            try {
                const res = await fetch(fileName);
                if (!res.ok) throw new Error("No encontrado");
                const text = await res.text();
                procesar(text);
                document.getElementById('status_file').innerText = "ARCHIVO CARGADO OK";
                document.getElementById('status_file').className = "text-[10px] font-bold text-emerald-500 uppercase";
            } catch (e) {
                document.getElementById('status_file').innerText = "ERROR: ARCHIVO '" + fileName + "' NO ENCONTRADO O BLOQUEADO";
            }
        }

        function t2s(t) { 
            if (!t || t.includes("N/A")) return 0;
            const p = t.toString().trim().split(':');
            return p.length < 2 ? 0 : (parseInt(p[0]) || 0) * 3600 + (parseInt(p[1]) || 0) * 60 + (parseInt(p[2]) || 0);
        }

        function s2t(s) { 
            const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
            return `${h}:${m.toString().padStart(2,'0')}`; 
        }

        function procesar(csv) {
            const lineas = csv.split(/\r?\n/).filter(l => l.trim().length > 10);
            // Autodetectar separador (coma o punto y coma)
            const sep = lineas[0].includes(';') ? ';' : ',';
            const cabecera = lineas[0].split(sep).map(h => h.trim().toUpperCase());
            
            const iAgente = cabecera.indexOf("AGENTE"), iHrs = cabecera.indexOf("HORAS LOGUEO"),
                  iDia = cabecera.indexOf("DIA"), iMes = cabecera.indexOf("MES"),
                  iSis = cabecera.indexOf("SISTEMA"), iArea = cabecera.indexOf("AREA");

            dataGlobal = {};
            let setFechas = new Set(), setAreas = new Set();
            mesesRef = {};

            for (let i = 1; i < lineas.length; i++) {
                const col = lineas[i].split(sep).map(c => c.trim());
                if (col.length < 5) continue;

                const ag = col[iAgente], fec = col[iDia], mesN = col[iMes]?.toUpperCase(),
                      sis = col[iSis]?.toUpperCase() || "", seg = t2s(col[iHrs]),
                      area = col[iArea] || "SIN AREA", mesId = fec.split('/')[1];

                if (!ag || !fec) continue;

                setFechas.add(fec);
                setAreas.add(area);
                if (mesId) mesesRef[mesId] = mesN;

                if (!dataGlobal[ag]) dataGlobal[ag] = { ag, area, logs: {} };
                if (!dataGlobal[ag].logs[fec]) dataGlobal[ag].logs[fec] = { SPR: 0, VIC: 0 };

                if (sis.includes("SPRINKLR")) dataGlobal[ag].logs[fec].SPR += seg;
                else dataGlobal[ag].logs[fec].VIC += seg;
            }

            fechasGlobal = [...setFechas].sort((a,b) => a.split('/').reverse().join('').localeCompare(b.split('/').reverse().join('')));
            
            // UI Selectores
            const sMes = document.getElementById('f_mes');
            sMes.innerHTML = '<option value="ALL">PERIODO COMPLETO</option>';
            Object.keys(mesesRef).sort().forEach(id => sMes.innerHTML += `<option value="${id}">${mesesRef[id]}</option>`);

            const sArea = document.getElementById('f_area');
            sArea.innerHTML = '<option value="ALL">TODAS LAS AREAS</option>';
            [...setAreas].sort().forEach(a => sArea.innerHTML += `<option value="${a}">${a}</option>`);

            render();
        }

        function render() {
            const mSel = document.getElementById('f_mes').value,
                  aSel = document.getElementById('f_area').value,
                  q = document.getElementById('busqueda').value.toUpperCase();

            document.getElementById('txt_mes_actual').innerText = mSel === "ALL" ? "PANEL GENERAL" : mesesRef[mSel];

            const fechasFiltradas = mSel === "ALL" ? fechasGlobal : fechasGlobal.filter(f => f.split('/')[1] === mSel);
            let html = "", tS = 0, tV = 0, alerts = 0;
            let timelineS = fechasFiltradas.map(() => 0), timelineV = fechasFiltradas.map(() => 0);

            Object.values(dataGlobal).forEach(u => {
                if ((aSel !== "ALL" && u.area !== aSel) || (q && !u.ag.toUpperCase().includes(q))) return;

                let uSum = 0, uOff = 0, boxes = "";
                fechasFiltradas.forEach((f, idx) => {
                    const reg = u.logs[f] || { SPR: 0, VIC: 0 };
                    const tot = reg.SPR + reg.VIC;
                    uSum += tot; tS += reg.SPR; tV += reg.VIC;
                    timelineS[idx] += reg.SPR; timelineV[idx] += reg.VIC;

                    if (tot === 0) uOff++;
                    const css = reg.SPR > reg.VIC ? 'spr-high' : (reg.VIC > 0 ? 'vic-high' : 'day-off');
                    boxes += `<div class="day-box ${css}" title="${f}: ${s2t(tot)}">${f.split('/')[0]}</div>`;
                });

                if (uOff > 2 && uSum > 0) alerts++;

                html += `<tr>
                    <td class="p-4 font-bold text-slate-800">${u.ag}<br><span class="text-[8px] text-slate-400 font-normal uppercase">${u.area}</span></td>
                    <td class="p-4 flex flex-wrap gap-1 justify-center">${boxes}</td>
                    <td class="p-4 text-right font-black text-slate-600">${s2t(uSum)}</td>
                </tr>`;
            });

            document.getElementById('t_body').innerHTML = html;
            document.getElementById('k_spr').innerText = s2t(tS);
            document.getElementById('k_vic').innerText = s2t(tV);
            document.getElementById('k_dias').innerText = fechasFiltradas.length;
            document.getElementById('k_alert').innerText = alerts;

            renderGraph(fechasFiltradas.map(f => f.substring(0,5)), timelineS.map(v => (v/3600).toFixed(1)), timelineV.map(v => (v/3600).toFixed(1)));
        }

        function renderGraph(l, s, v) {
            Plotly.newPlot('g_linea', [
                { x: l, y: s, name: 'Spr', type: 'scatter', mode: 'lines+markers', line: {color: '#2563eb'} },
                { x: l, y: v, name: 'Vic', type: 'scatter', mode: 'lines+markers', line: {color: '#f97316'} }
            ], { margin: {t:20, b:40, l:40, r:20}, showlegend: false, hovermode: 'x unified' }, {responsive: true});
        }

        document.getElementById('f_mes').onchange = render;
        document.getElementById('f_area').onchange = render;
        document.getElementById('busqueda').oninput = render;

        function generarExcel() {
            const data = Object.values(dataGlobal).map(u => ({ "AGENTE": u.ag, "AREA": u.area }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Auditoria");
            XLSX.writeFile(wb, "GMT_REPORTE.xlsx");
        }
    </script>
</body>
</html>
