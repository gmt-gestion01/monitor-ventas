<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT CONTROL | AUDITOR칈A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        .day-box { width: 22px; height: 22px; border-radius: 4px; font-size: 9px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: bold; }
        .spr-high { background-color: #2563eb; color: white; }
        .vic-high { background-color: #f97316; color: white; }
        .day-off { background-color: #f1f5f9; color: #cbd5e1; border: 1px solid #e2e8f0; }
        .table-scroll { max-height: 70vh; overflow-y: auto; border-radius: 0 0 1.5rem 1.5rem; }
    </style>
</head>
<body class="bg-slate-100 p-4">
    <div class="max-w-7xl mx-auto">
        
        <div class="bg-white p-6 rounded-2xl shadow-sm border mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-black text-slate-900 tracking-tighter uppercase">GMT <span class="text-blue-600">Auditor칤a</span></h1>
                <p id="status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Esperando archivo...</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-2">
                <select id="filter_ger" onchange="render()" class="bg-slate-50 border border-slate-200 text-[10px] font-black px-4 py-2 rounded-xl outline-none focus:border-blue-500 uppercase"></select>
                <input type="text" id="search" oninput="render()" placeholder="BUSCAR ASESOR..." class="border border-slate-200 text-[10px] font-black px-4 py-2 rounded-xl outline-none w-48 focus:border-blue-500 uppercase">
                <button onclick="generarExcel()" class="bg-emerald-600 text-white text-[10px] font-black px-5 py-2 rounded-xl hover:bg-emerald-700 transition-all uppercase">游늵 Excel</button>
            </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-3xl shadow-xl overflow-hidden">
            <div class="bg-slate-900 p-4 flex justify-between items-center">
                <h2 class="text-white text-[10px] font-black uppercase tracking-widest italic">Detalle de Conexi칩n 2026</h2>
                <div id="date-range" class="text-blue-400 text-[9px] font-bold uppercase"></div>
            </div>
            
            <div class="table-scroll">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 sticky top-0 border-b z-10">
                        <tr class="text-[9px] text-slate-400 font-black uppercase">
                            <th class="p-4">Ejecutivo / Gerencia</th>
                            <th class="p-4 text-center">Actividad</th>
                            <th class="p-4 text-center">Horas Acum.</th>
                            <th class="p-4">Campa침a</th>
                            <th class="p-4 text-center">Calendario de Auditor칤a</th>
                        </tr>
                    </thead>
                    <tbody id="t_body" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="debug-console" class="mt-6 p-4 bg-red-50 border border-red-200 rounded-xl hidden">
            <p class="text-red-600 font-black text-xs uppercase mb-2">Error de Carga:</p>
            <div id="error-msg" class="text-red-500 font-mono text-[10px]"></div>
        </div>
    </div>

    <script>
        // --- ARQUITECTURA DE DATOS: VARIABLES ---
        let rawData = [];
        let dates = [];

        // --- L칍GICA DE TIEMPO ---
        const tToSec = (t) => {
            if (!t || t.toString().includes('N/D')) return 0;
            const p = t.toString().trim().split(':');
            return p.length >= 2 ? (parseInt(p[0]) * 3600) + (parseInt(p[1]) * 60) + (parseInt(p[2] || 0)) : 0;
        };

        const secToT = (s) => {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return `${h}h ${m}m`;
        };

        // --- ARQUITECTURA DE DATOS: PROCESAMIENTO DIN츼MICO ---
        async function cargarDatos() {
            const status = document.getElementById('status-text');
            const debug = document.getElementById('debug-console');
            const errorMsg = document.getElementById('error-msg');

            try {
                // INTENTO DE CARGAR data_02.csv (C치mbialo a data_01.csv si es necesario)
                const response = await fetch('data_02.csv'); 
                if (!response.ok) throw new Error("No se pudo leer el archivo CSV. Aseg칰rate de que 'data_02.csv' est칠 en la misma carpeta.");

                const text = await response.text();
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
                if (lines.length < 2) throw new Error("El archivo CSV est치 vac칤o o no tiene el formato correcto.");

                const sep = lines[0].includes(';') ? ';' : ',';
                const headers = lines[0].split(sep).map(h => h.trim());
                
                // Buscar inicio de fechas din치micamente
                const dateIdx = headers.findIndex(h => h.includes('/'));
                dates = headers.slice(dateIdx).filter(h => h.includes('/'));
                document.getElementById('date-range').innerText = `Rango: ${dates[0]} al ${dates[dates.length-1]}`;

                // Agrupaci칩n inteligente
                const tempMap = {};
                lines.slice(1).forEach(line => {
                    const c = line.split(sep).map(x => x.replace(/"/g, '').trim());
                    if (c.length < 5) return;

                    const sistema = c[0].toUpperCase();
                    const nombre = c[1];
                    const gerencia = c[3] || "S/G";
                    const campana = c[4] || "S/C";
                    const daily = c.slice(dateIdx);

                    if (!tempMap[nombre]) {
                        tempMap[nombre] = { nombre, gerencia, campana, systems: {} };
                    }
                    tempMap[nombre].systems[sistema] = daily;
                });

                rawData = Object.values(tempMap);

                // Llenar filtro de Gerencia
                const gers = [...new Set(rawData.map(r => r.gerencia))].sort();
                document.getElementById('filter_ger').innerHTML = '<option value="">GERENCIAS (TODAS)</option>' + 
                    gers.map(g => `<option value="${g}">${g}</option>`).join('');

                status.innerText = `ONLINE: ${rawData.length} ASESORES CARGADOS`;
                status.classList.replace('text-slate-400', 'text-emerald-500');
                render();

            } catch (err) {
                status.innerText = "ERROR DE CARGA";
                status.classList.replace('text-slate-400', 'text-red-500');
                debug.classList.remove('hidden');
                errorMsg.innerText = err.message;
            }
        }

        // --- COMPONENTES DEL TABLERO: RENDER ---
        function render() {
            const filterGer = document.getElementById('filter_ger').value;
            const searchName = document.getElementById('search').value.toUpperCase();
            const tbody = document.getElementById('t_body');

            let processed = rawData.map(u => {
                let totalSec = 0;
                let daysAct = 0;
                let dailyMatrix = [];

                for (let i = 0; i < dates.length; i++) {
                    let daySec = 0;
                    let hasSpr = false;
                    
                    Object.keys(u.systems).forEach(s => {
                        const sSec = tToSec(u.systems[s][i]);
                        daySec += sSec;
                        if (s.includes('SPR')) hasSpr = true;
                    });

                    if (daySec > 0) daysAct++;
                    totalSec += daySec;
                    dailyMatrix.push({ sec: daySec, type: hasSpr ? 'SPR' : 'VIC', label: dates[i].split('/')[0] });
                }
                return { ...u, totalSec, daysAct, dailyMatrix };
            });

            // Aplicar Filtros
            processed = processed.filter(u => 
                (!filterGer || u.gerencia === filterGer) && 
                (!searchName || u.nombre.toUpperCase().includes(searchName))
            );

            // Ordenar por Alerta (menos d칤as activos primero)
            processed.sort((a, b) => a.daysAct - b.daysAct);

            tbody.innerHTML = processed.map(u => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-4">
                        <div class="font-black text-slate-800 uppercase text-[10px] tracking-tighter">${u.nombre}</div>
                        <div class="text-[8px] text-slate-400 font-bold uppercase">${u.gerencia}</div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded-md font-black text-[8px] ${u.daysAct < 4 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">
                            ${u.daysAct} D칈AS
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <div class="font-mono font-bold text-slate-600 text-[10px]">${secToT(u.totalSec)}</div>
                    </td>
                    <td class="p-4 text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${u.campana}</td>
                    <td class="p-4 flex gap-1 justify-center flex-wrap">
                        ${u.dailyMatrix.map(d => `
                            <div class="day-box ${d.sec > 0 ? (d.type === 'SPR' ? 'spr-high' : 'vic-high') : 'day-off'}" title="${d.sec > 0 ? secToT(d.sec) : 'Sin conexi칩n'}">
                                ${d.label}
                            </div>
                        `).join('')}
                    </td>
                </tr>
            `).join('');
        }

        // --- HERRAMIENTAS DE CONTROL: EXPORTAR ---
        function generarExcel() {
            const exportData = rawData.map(u => {
                let sec = 0, act = 0;
                dates.forEach((d, i) => {
                    let dSec = 0; Object.values(u.systems).forEach(s => dSec += tToSec(s[i]));
                    if(dSec > 0) act++; sec += dSec;
                });
                return { "ASESOR": u.nombre, "GERENCIA": u.gerencia, "CAMPA칌A": u.campana, "HORAS": secToT(sec), "D칈AS": act };
            });
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Auditoria");
            XLSX.writeFile(wb, "GMT_REPORTE.xlsx");
        }

        window.onload = cargarDatos;
    </script>
</body>
</html>
