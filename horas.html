<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT CONTROL | AUDITORÍA BI</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .day-box { width: 18px; height: 18px; border-radius: 4px; font-size: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: bold; }
        .spr-high { background-color: #2563eb; color: white; }
        .vic-high { background-color: #f97316; color: white; }
        .day-off { background-color: #f1f5f9; color: #cbd5e1; border: 1px solid #e2e8f0; }
        #login_layer { position: fixed; inset: 0; background: #0f172a; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .debug-panel { background: #fee2e2; border: 2px solid #ef4444; padding: 10px; margin-bottom: 15px; border-radius: 10px; font-family: monospace; font-size: 10px; color: #b91c1c; }
    </style>
</head>
<body class="bg-slate-50 p-4">

    <div id="login_layer">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center border-t-8 border-blue-600">
            <h2 class="text-2xl font-black mb-6 uppercase">GMT ACCESS</h2>
            <form id="form_acceso" class="space-y-4">
                <input type="text" id="user_name" placeholder="USUARIO" required class="w-full p-4 bg-slate-50 border-2 rounded-xl text-center font-bold outline-none focus:border-blue-600">
                <input type="password" id="pass" placeholder="CONTRASEÑA" required class="w-full p-4 bg-slate-50 border-2 rounded-xl text-center font-bold outline-none focus:border-blue-600">
                <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black uppercase shadow-lg hover:bg-blue-700 transition-all">Entrar</button>
            </form>
        </div>
    </div>

    <div id="dashboard_wrapper" class="hidden max-w-7xl mx-auto">
        
        <div id="debug_info" class="debug-panel hidden">
            <strong>SISTEMA DE DIAGNÓSTICO:</strong>
            <ul id="debug_list" class="list-disc ml-5 mt-1"></ul>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-black text-slate-900 uppercase">GMT AUDITORÍA <span class="text-blue-600">BI</span></h1>
                <p id="data_status" class="text-[10px] font-bold text-slate-400 uppercase italic">Verificando datos...</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <select id="filter_month" onchange="actualizarSemanas()" class="bg-white border-2 border-slate-100 text-[10px] font-black px-3 py-2 rounded-lg"></select>
                <select id="filter_week" onchange="renderDashboard()" class="bg-white border-2 border-slate-100 text-[10px] font-black px-3 py-2 rounded-lg"></select>
                <select id="filter_ger" onchange="renderDashboard()" class="bg-slate-900 text-white text-[10px] font-black px-3 py-2 rounded-lg"></select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-4 rounded-2xl border shadow-sm">
                <div id="g_weekly" style="height: 300px;"></div>
            </div>
            <div class="bg-white p-4 rounded-2xl border shadow-sm">
                <div id="g_pie" style="height: 300px;"></div>
            </div>
        </div>

        <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b border-slate-100">
                    <tr class="text-[10px] font-black text-slate-400 uppercase">
                        <th class="p-4">Ejecutivo</th>
                        <th class="p-4 text-center">Asistencia Visual</th>
                    </tr>
                </thead>
                <tbody id="t_body_calendar" class="divide-y divide-slate-50 text-[11px]"></tbody>
            </table>
        </div>
    </div>

    <script>
        const USERS_DB = { "ADMIN": "gmt2026" };
        let rawDataFRows = [], globalDates = [], groupedData = {}, monthsFound = {};

        // 1. GESTIÓN DE LOGIN
        document.getElementById('form_acceso').onsubmit = e => {
            e.preventDefault();
            if(USERS_DB[document.getElementById('user_name').value.toUpperCase()] === document.getElementById('pass').value) {
                document.getElementById('login_layer').style.display = 'none';
                document.getElementById('dashboard_wrapper').classList.remove('hidden');
                cargarData();
            } else { alert("Error"); }
        };

        // 2. CARGA Y AUTODIAGNÓSTICO
        function cargarData() {
            const debug = (msg) => {
                document.getElementById('debug_info').classList.remove('hidden');
                const li = document.createElement('li'); li.innerText = msg;
                document.getElementById('debug_list').appendChild(li);
            };

            fetch('data.csv')
                .then(res => res.text())
                .then(csv => {
                    const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
                    if(lines.length < 2) { debug("El archivo CSV está vacío o mal formado."); return; }
                    
                    const sep = lines[0].includes(';') ? ';' : ',';
                    const headers = lines[0].split(sep);
                    
                    // VALIDACIÓN DE COLUMNAS
                    if(headers.length < 10) {
                        debug(`Tu CSV solo tiene ${headers.length} columnas. El sistema espera al menos 10 (A a J).`);
                    }

                    // EXTRACCIÓN DE FECHAS
                    globalDates = headers.slice(9).map(d => d.trim().replace(/['"]+/g, ''));
                    if(globalDates.length === 0 || !globalDates[0].includes('/')) {
                        debug(`No se detectaron fechas en la columna J en adelante. Cabecera leída: ${headers[9]}`);
                    }

                    procesarCSV(lines, sep);
                })
                .catch(err => debug("No se pudo leer 'data.csv'. Verifica que el nombre sea exacto."));
        }

        function tToSec(t) {
            if(!t || t == "0") return 0;
            const p = t.toString().replace(/['"]+/g, '').trim().split(':');
            return p.length < 2 ? 0 : (parseInt(p[0]) * 3600) + (parseInt(p[1]) * 60) + (parseInt(p[2] || 0));
        }

        function procesarCSV(lines, sep) {
            monthsFound = {};
            globalDates.forEach((d, idx) => {
                const parts = d.split('/');
                if(parts.length < 2) return;
                const mKey = parts[1];
                if(!monthsFound[mKey]) monthsFound[mKey] = { name: "MES "+mKey, indices: [] };
                monthsFound[mKey].indices.push(idx);
            });

            // Llenar Meses
            const ms = document.getElementById('filter_month');
            ms.innerHTML = Object.keys(monthsFound).sort().map(m => `<option value="${m}">${monthsFound[m].name}</option>`).join('');

            // Agrupar Datos
            rawDataFRows = []; groupedData = {};
            lines.slice(1).forEach(line => {
                const c = line.split(sep);
                if (c.length < 10) return;
                const sis = c[0].replace(/['"]+/g, '').toUpperCase().trim();
                const name = c[1].replace(/['"]+/g, '').trim();
                const ger = (c[3] || 'N/D').replace(/['"]+/g, '').trim().toUpperCase();
                const daily = c.slice(9);
                
                rawDataFRows.push({ sis, name, ger, daily });
                if(!groupedData[name]) groupedData[name] = { name, ger, systems: {} };
                groupedData[name].systems[sis] = { daily };
            });

            const gers = [...new Set(rawDataFRows.map(d => d.ger))].sort();
            document.getElementById('filter_ger').innerHTML = gers.map(g => `<option value="${g}">${g}</option>`).join('');
            
            actualizarSemanas();
        }

        function actualizarSemanas() {
            const mKey = document.getElementById('filter_month').value;
            const ws = document.getElementById('filter_week');
            let baseDates = monthsFound[mKey].indices;
            ws.innerHTML = '<option value="ALL">TODO EL MES</option>';
            for(let i=0; i < Math.ceil(baseDates.length/7); i++) ws.innerHTML += `<option value="${i}">SEMANA ${i+1}</option>`;
            renderDashboard();
        }

        function renderDashboard() {
            const ger = document.getElementById('filter_ger').value;
            const m = document.getElementById('filter_month').value;
            const w = document.getElementById('filter_week').value;
            
            let rango = monthsFound[m].indices;
            if(w !== "ALL") rango = rango.slice(parseInt(w)*7, (parseInt(w)+1)*7);

            let s_spr = 0, s_vic = 0, sprV = [], vicV = [], labels = [];
            let filtered = rawDataFRows.filter(r => r.ger === ger);

            rango.forEach(idx => {
                labels.push(globalDates[idx]);
                let dS = 0, dV = 0;
                filtered.forEach(r => {
                    const s = tToSec(r.daily[idx]);
                    if(r.sis.includes('SPR')) dS += s; else dV += s;
                });
                s_spr += dS; s_vic += dV;
                sprV.push(dS/3600); vicV.push(dV/3600);
            });

            // GRÁFICAS
            Plotly.newPlot('g_weekly', [
                { x: labels, y: sprV, name: 'Sprinklr', type: 'scatter', line: {color: '#2563eb'} },
                { x: labels, y: vicV, name: 'Vicidial', type: 'scatter', line: {color: '#f97316'} }
            ], { title: 'HORAS DIARIAS', margin: {t:40, b:40, l:40, r:10} });

            Plotly.newPlot('g_pie', [{
                labels: ['Sprinklr', 'Vicidial'], values: [s_spr, s_vic], type: 'pie', marker: {colors:['#2563eb', '#f97316']}
            }], { title: 'MIX DE USO' });

            // CALENDARIO
            let h = "";
            const asesoresGerencia = Object.values(groupedData).filter(d => d.ger === ger);
            asesoresGerencia.forEach(d => {
                h += `<tr><td class="p-4 font-bold uppercase">${d.name}</td><td class="p-4 flex gap-1 flex-wrap">`;
                rango.forEach(idx => {
                    let hasCnx = false, sisType = "";
                    Object.keys(d.systems).forEach(s => {
                        if(tToSec(d.systems[s].daily[idx]) > 0) { hasCnx = true; sisType = s; }
                    });
                    h += `<div class="day-box ${hasCnx ? (sisType.includes('SPR') ? 'spr-high' : 'vic-high') : 'day-off'}">${globalDates[idx].split('/')[0]}</div>`;
                });
                h += `</td></tr>`;
            });
            document.getElementById('t_body_calendar').innerHTML = h;
        }
    </script>
</body>
</html>
