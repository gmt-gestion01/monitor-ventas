<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMT AUDIT | Dashboard Consolidado</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .day-box { width: 22px; height: 22px; border-radius: 4px; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 1px; flex-shrink: 0; }
        .spr-high { background-color: #2563eb; color: white; }
        .day-off { background-color: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; }
        .card-stat { border-left: 5px solid #2563eb; background: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card-stat:hover { transform: translateY(-3px); }
        .alert-zone { background: #fff1f2; border: 2px solid #fecdd3; border-radius: 1.5rem; }
        body { background-color: #f8fafc; font-family: sans-serif; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-[1600px] mx-auto">
        <div class="bg-white p-6 rounded-3xl shadow-sm border mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-2xl text-white font-black italic text-xl shadow-lg">GMT</div>
                <h1 class="text-xl font-black uppercase tracking-tighter italic text-slate-800">Auditor칤a <span class="text-blue-600">Performance</span></h1>
            </div>
            <div class="flex gap-3">
                <div class="flex flex-col">
                    <label class="text-[9px] font-bold text-slate-400 ml-1 uppercase">Filtro Mes</label>
                    <select id="sel_mes" class="bg-white border p-2 rounded-xl font-bold text-sm outline-none shadow-sm min-w-[120px]"></select>
                </div>
                <div class="flex flex-col">
                    <label class="text-[9px] font-bold text-slate-400 ml-1 uppercase">Filtro D칤a</label>
                    <select id="sel_dia" class="bg-white border p-2 rounded-xl font-bold text-sm outline-none shadow-sm min-w-[100px]">
                        <option value="ALL">TODOS</option>
                    </select>
                </div>
                <button onclick="cargarDesdeGitHub()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-black text-[11px] uppercase self-end mb-1 shadow-md hover:bg-blue-700">Actualizar</button>
            </div>
        </div>

        <div id="cards_container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6"></div>

        <div class="alert-zone p-6 mb-6 shadow-sm">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-red-600 font-black text-lg uppercase flex items-center gap-2">丘멆잺 Alertas Cr칤ticas de Conexi칩n</h3>
                    <p id="alert_text" class="text-red-500 font-bold text-xs uppercase italic">Calculando...</p>
                </div>
                <button onclick="descargarAlertas()" class="bg-red-600 text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-lg hover:bg-red-700">Descargar Lista de Bajas</button>
            </div>
        </div>

        <div class="flex flex-col gap-6 mb-6">
            <div class="bg-white p-6 rounded-3xl border shadow-sm"><div id="chart_tendencia" style="height: 380px;"></div></div>
            <div class="bg-white p-6 rounded-3xl border shadow-sm"><div id="chart_gerencias" style="height: 480px;"></div></div>
        </div>

        <div class="bg-white rounded-3xl border shadow-sm overflow-hidden">
            <div class="p-6 border-b flex flex-col md:flex-row justify-between items-center bg-slate-50 gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-[10px] font-black text-slate-400 uppercase">Gerente:</span>
                    <select id="sel_ger" class="p-2 border rounded-lg font-bold text-xs uppercase outline-none bg-white min-w-[220px] shadow-sm"></select>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-bold text-slate-400 uppercase">Horas Totales Seleccionadas</p>
                    <p class="text-3xl font-black text-blue-600" id="kpi_sum_hrs">0:00</p>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[600px]">
                <table class="w-full text-[11px] text-left">
                    <thead class="bg-slate-100 text-slate-500 font-bold uppercase sticky top-0 z-10">
                        <tr>
                            <th class="p-4">Ejecutivo</th>
                            <th class="p-4">Gerencia (Col E)</th>
                            <th class="p-4 text-center">Calendario de Conexi칩n</th>
                            <th class="p-4 text-right">Hrs</th>
                        </tr>
                    </thead>
                    <tbody id="table_body" class="divide-y divide-slate-100 bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_URL = "https://raw.githubusercontent.com/gmt-gestion01/monitor-ventas/main/HORAS_ACUMULADO_HC_1.csv";
        let dataGlobal = {}, fechasGlobal = [], mesesDisp = {}, ejecutivosBajos = [];

        window.onload = cargarDesdeGitHub;

        async function cargarDesdeGitHub() {
            try {
                const resp = await fetch(GITHUB_URL + "?nocache=" + new Date().getTime());
                const texto = await resp.text();
                procesarCSV(texto);
            } catch (e) { console.error("Error de carga"); }
        }

        function t2s(t) {
            if(!t) return 0;
            const p = t.split(':');
            return p.length >= 2 ? (+p[0]*3600) + (+p[1]*60) + (+p[2]||0) : 0;
        }

        function s2t(s) {
            const h = Math.floor(s/3600);
            const m = Math.floor((s%3600)/60);
            return `${h}:${m.toString().padStart(2,'0')}`;
        }

        function procesarCSV(csv) {
            const lineas = csv.split(/\r?\n/).filter(l => l.trim().length > 10);
            const sep = lineas[0].includes(';') ? ';' : ',';
            
            // 칈ndices espec칤ficos: 0:Agente, 1:Usuario, 2:Hrs, 4:Gerencia (Col E), 7:Dia (fecha), 8:Mes
            const iAg=0, iUs=1, iHr=2, iGe=4, iDi=7, iMe=8;
            
            dataGlobal = {}; fechasGlobal = []; mesesDisp = {}; 
            let setF = new Set(), setG = new Set();

            lineas.slice(1).forEach(l => {
                const c = l.split(sep).map(v => v.trim());
                if(c.length < 8) return;
                
                let ger = (c[iGe] || "SIN GERENCIA").toUpperCase();
                if(ger === "" || ger === "UNDEFINED") ger = "SIN GERENCIA";
                
                const us = c[iUs], fec = c[iDi], mes = c[iMe];
                if(!us || !fec) return;

                setF.add(fec);
                setG.add(ger);
                if(mes) mesesDisp[mes.toLowerCase()] = mes.toLowerCase();

                if(!dataGlobal[us]) dataGlobal[us] = { ag: c[iAg], us, ger, logs: {} };
                dataGlobal[us].logs[fec] = (dataGlobal[us].logs[fec] || 0) + t2s(c[iHr]);
            });

            fechasGlobal = [...setF].sort((a,b) => a.split('/').reverse().join('').localeCompare(b.split('/').reverse().join('')));
            
            // Selector de Mes con opci칩n TODOS
            let mesHtml = '<option value="ALL">TODOS LOS MESES</option>';
            Object.keys(mesesDisp).sort().forEach(m => {
                mesHtml += `<option value="${m}">${m.toUpperCase()}</option>`;
            });
            document.getElementById('sel_mes').innerHTML = mesHtml;

            document.getElementById('sel_ger').innerHTML = '<option value="ALL">TODAS LAS GERENCIAS</option>' + [...setG].sort().map(g => `<option value="${g}">${g}</option>`).join('');

            actualizarDias();
            render();
        }

        function actualizarDias() {
            const m = document.getElementById('sel_mes').value;
            let filtradas = fechasGlobal;
            if(m !== "ALL") {
                // Aqu칤 podr칤as filtrar fechasGlobal por el mes, pero para mantener la vista general lo dejamos din치mico
            }
            document.getElementById('sel_dia').innerHTML = '<option value="ALL">TODOS</option>' + 
                filtradas.map(f => `<option value="${f}">${f.split('/')[0]}</option>`).join('');
        }

        function render() {
            const mesSel = document.getElementById('sel_mes').value;
            const diaSel = document.getElementById('sel_dia').value;
            const gerSel = document.getElementById('sel_ger').value;
            
            let list = [], statsG = {}, trend = {};
            ejecutivosBajos = [];
            fechasGlobal.forEach(f => trend[f] = 0);

            Object.values(dataGlobal).forEach(u => {
                let sum = 0, onCount = 0, boxesHtml = "";
                
                fechasGlobal.forEach(f => {
                    const hrsDia = u.logs[f] || 0;
                    // L칩gica de filtrado por mes
                    const esMesCorrecto = (mesSel === "ALL" || f.toLowerCase().includes(mesSel));
                    
                    if (esMesCorrecto) {
                        if(diaSel === "ALL" || f === diaSel) sum += hrsDia;
                        if(hrsDia > 0) {
                            onCount++;
                            trend[f] += hrsDia;
                        }
                        boxesHtml += `<div class="day-box ${hrsDia > 0 ? 'spr-high' : 'day-off'}">${f.split('/')[0]}</div>`;
                    }
                });

                if(sum > 0 || (mesSel === "ALL" && onCount > 0)) {
                    if(!statsG[u.ger]) statsG[u.ger] = { h: 0, n: 0 };
                    statsG[u.ger].h += sum;
                    statsG[u.ger].n++;
                    
                    const obj = { ...u, sum, onCount, boxesHtml };
                    if(onCount < 3 && onCount > 0) ejecutivosBajos.push(obj);
                    if(gerSel === "ALL" || u.ger === gerSel) list.push(obj);
                }
            });

            // TARJETAS (Muestran el top 5 por horas)
            const sG = Object.entries(statsG).sort((a,b) => b[1].h - a[1].h);
            document.getElementById('cards_container').innerHTML = sG.slice(0, 5).map(([n, d]) => `
                <div class="p-4 card-stat">
                    <p class="text-[9px] font-black text-slate-400 uppercase truncate">${n}</p>
                    <h3 class="text-xl font-black text-slate-800">${s2t(d.h)}</h3>
                    <p class="text-[10px] font-bold text-blue-600">游논 ${d.n} Ejecutivos</p>
                </div>`).join('');

            document.getElementById('alert_text').innerText = `Se detectaron ${ejecutivosBajos.length} ejecutivos con menos de 3 conexiones en el periodo seleccionado.`;
            document.getElementById('kpi_sum_hrs').innerText = s2t(list.reduce((a,b) => a + b.sum, 0));

            // TABLA (MENOS D칈AS PRIMERO)
            document.getElementById('table_body').innerHTML = list.sort((a,b) => a.onCount - b.onCount).map(u => `
                <tr>
                    <td class="p-4"><b>${u.ag}</b><br><span class="text-[9px] text-slate-400 font-mono">${u.us}</span></td>
                    <td class="p-4 font-bold text-slate-500 uppercase">${u.ger}</td>
                    <td class="p-4 flex flex-wrap justify-center gap-1">${u.boxesHtml}</td>
                    <td class="p-4 text-right font-black text-slate-700">${s2t(u.sum)}</td>
                </tr>`).join('');

            // GR츼FICA TENDENCIA CON ETIQUETAS
            const xVal = Object.keys(trend).filter(f => trend[f] > 0).map(f => f.split('/')[0]);
            const yVal = Object.keys(trend).filter(f => trend[f] > 0).map(f => (trend[f]/3600).toFixed(1));
            Plotly.newPlot('chart_tendencia', [{
                x: xVal, y: yVal, type: 'scatter', mode: 'lines+markers+text',
                text: yVal, textposition: 'top center',
                line: { color: '#2563eb', width: 3 }, fill: 'tozeroy', fillcolor: 'rgba(37, 99, 235, 0.1)'
            }], { 
                title: { text: 'CONSOLIDADO DE HORAS POR D칈A', font: {size:14, family:'Arial Black'} },
                margin: {l:50, r:50, t:50, b:50}
            }, { responsive: true, displayModeBar: false });

            // GR츼FICA BARRAS CON ETIQUETAS
            const sGSorted = [...sG].reverse();
            Plotly.newPlot('chart_gerencias', [{
                y: sGSorted.map(e => e[0]), x: sGSorted.map(e => (e[1].h/3600).toFixed(1)),
                type: 'bar', orientation: 'h', marker: { color: '#2563eb' },
                text: sGSorted.map(e => (e[1].h/3600).toFixed(1) + "h"), textposition: 'outside'
            }], { 
                title: { text: 'ACUMULADO POR GERENCIA', font: {size:14, family:'Arial Black'} },
                margin: {l:180, r:50, t:50, b:50}
            }, { responsive: true, displayModeBar: false });
        }

        function descargarAlertas() {
            let csv = "Agente,Usuario,Gerencia,Dias_Conectados\n";
            ejecutivosBajos.forEach(e => {
                csv += `"${e.ag}","${e.us}","${e.ger}",${e.onCount}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'alertas_GMT_baja_conexion.csv'; a.click();
        }

        document.getElementById('sel_mes').addEventListener('change', () => { actualizarDias(); render(); });
        document.getElementById('sel_dia').addEventListener('change', render);
        document.getElementById('sel_ger').addEventListener('change', render);
    </script>
</body>
</html>
