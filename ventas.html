<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT | MONITOR VENTAS</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div id="dashboard-content" class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-4xl font-black italic text-slate-800">GMT VENTAS</h1>
            <select id="month_filter" onchange="updateDayFilter()" class="border-2 p-2 rounded-xl text-xs font-black"></select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-white">
            <div class="bg-blue-800 p-8 rounded-3xl text-center">
                <p class="text-xs font-bold opacity-70">VENTAS BRUTAS</p>
                <h2 id="total_ventas" class="text-6xl font-black">0</h2>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-xl mb-8">
            <div id="g_tendencia" style="height: 400px;"></div>
        </div>

        <div id="supervisor_grid" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
    </div>

    <script>
        let globalRawData = [];

        function autoLoadCSV() {
            fetch(`ventas.csv?v=${Date.now()}`)
                .then(res => res.text())
                .then(text => {
                    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
                    const sep = lines[0].includes(';') ? ';' : ',';
                    
                    globalRawData = lines.slice(1).map(line => {
                        const c = line.split(sep).map(x => x.trim());
                        if(!c[1]) return null;
                        return { 
                            fVenta: c[1], 
                            supervisor: c[2] || "S/S", 
                            mes: c[9] ? c[9].toLowerCase() : "febrero" 
                        };
                    }).filter(d => d !== null);

                    const meses = [...new Set(globalRawData.map(d => d.mes))];
                    document.getElementById('month_filter').innerHTML = meses.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
                    updateDayFilter();
                });
        }

        function updateDayFilter() {
            render();
        }

        function render() {
            const selMes = document.getElementById('month_filter').value;
            const data = globalRawData.filter(d => d.mes === selMes);
            
            document.getElementById('total_ventas').innerText = data.length;

            // Gráfica simple
            const dates = [...new Set(data.map(d => d.fVenta))].sort();
            const counts = dates.map(dt => data.filter(d => d.fVenta === dt).length);

            Plotly.newPlot('g_tendencia', [{
                x: dates, y: counts, type: 'scatter', mode: 'lines+markers',
                line: {color: '#1e3a8a', width: 3}
            }], { title: 'VENTAS POR DÍA' });

            // Supervisores
            const supers = [...new Set(data.map(d => d.supervisor))].sort();
            document.getElementById('supervisor_grid').innerHTML = supers.map(s => {
                const cant = data.filter(x => x.supervisor === s).length;
                return `<div class="bg-white p-4 rounded-2xl border shadow-sm text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">${s}</p>
                    <p class="text-2xl font-black text-slate-800">${cant}</p>
                </div>`;
            }).join('');
        }

        window.onload = autoLoadCSV;
    </script>
</body>
</html>
