<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT | MONITOR ESTRATÉGICO</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        
        .bg-main-dark { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); }
        .bg-movistar { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
        .bg-gmt { background: linear-gradient(135deg, #9a3412 0%, #f97316 100%); }
        
        .glass-card { background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
        .stat-label { font-size: 0.65rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; }
        .flag-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; border: 2px solid rgba(255,255,255,0.2); }
        .sup-card { transition: all 0.2s; border: 1px solid #e2e8f0; border-radius: 2.5rem; background: white; overflow: hidden; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-center gap-6 mb-10">
            <div class="text-center lg:text-left">
                <h1 class="text-6xl font-black tracking-tighter uppercase italic py-2">
                    <span style="background: linear-gradient(180deg, #ff9d42 0%, #ff6b00 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 1px 1px 0px #b45309, 2px 2px 0px #92400e; display: inline-block;">GMT</span>
                    <span style="background: linear-gradient(180deg, #58a5ff 0%, #0056ce 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 1px 1px 0px #1e40af, 2px 2px 0px #1e3a8a; display: inline-block; margin-left: 2px;">PREPAGO</span>
                </h1>
                <p class="text-slate-400 font-bold text-[11px] uppercase tracking-[0.45em] mt-[-4px] pl-1">Sincronización Automática | 2026</p>
            </div>
            <div id="status_box" class="flex items-center gap-2 bg-white px-4 py-2 rounded-full border shadow-sm">
                <div id="status_led" class="h-3 w-3 rounded-full bg-slate-300"></div>
                <span id="status_text" class="text-[10px] font-black uppercase text-slate-500">Cargando...</span>
            </div>
        </header>

        <div class="glass-card rounded-[3rem] overflow-hidden mb-8 shadow-xl">
            <div class="grid grid-cols-1 md:grid-cols-3 text-white text-center">
                <div class="bg-main-dark p-10 md:border-r border-white/10">
                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-200 mb-2">Ventas Brutas</p>
                    <h2 id="k_bruto" class="text-7xl font-black italic leading-none">0</h2>
                    <span id="k_ritmo" class="text-[11px] font-bold text-blue-300/80 uppercase tracking-tighter">Ritmo: 0 / día</span>
                </div>
                <div class="bg-movistar p-10 md:border-r border-white/10">
                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-emerald-100 mb-2">Meta Movistar (509)</p>
                    <div class="flex flex-col items-center">
                        <div class="flex items-center mb-1">
                            <span id="flag_509" class="flag-dot bg-slate-400"></span>
                            <h2 id="k_cumplimiento_509" class="text-6xl font-black italic">0%</h2>
                        </div>
                        <span id="k_gap_509" class="text-3xl font-black text-white/90">0</span>
                    </div>
                </div>
                <div class="bg-gmt p-10">
                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-orange-100 mb-2">Meta GMT (604)</p>
                    <div class="flex flex-col items-center">
                        <div class="flex items-center mb-1">
                            <span id="flag_604" class="flag-dot bg-slate-400"></span>
                            <h2 id="k_cumplimiento_604" class="text-6xl font-black italic">0%</h2>
                        </div>
                        <span id="k_gap_604" class="text-3xl font-black text-white/90">0</span>
                    </div>
                </div>
            </div>

            <div class="p-10 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8 text-center bg-white">
                <div><p class="stat-label text-blue-600">Alta</p><h3 id="alta_rel" class="text-4xl font-black">0%</h3><p id="alta_abs" class="text-[10px] text-slate-400">0 ud</p></div>
                <div><p class="stat-label text-orange-500">Tráfico</p><h3 id="trafico_rel" class="text-4xl font-black">0%</h3><p id="trafico_abs" class="text-[10px] text-slate-400">0 ud</p></div>
                <div><p class="stat-label text-blue-400">ARPU</p><h3 id="k_arpu" class="text-4xl font-black">$0</h3></div>
                <div><p class="stat-label text-emerald-500 italic">Enrolado</p><h3 id="enrol_rel_main" class="text-4xl font-black">0%</h3></div>
            </div>
        </div>

        <div class="glass-card p-8 rounded-[2.5rem] mb-8">
            <h4 class="stat-label mb-6 text-center text-slate-600 uppercase italic">Ventas Diarias vs Objetivos</h4>
            <div id="g_tendencia" style="height: 350px;"></div>
        </div>

        <div id="recarga_section" class="glass-card rounded-[2.5rem] p-8 border-t-4 border-orange-500 mb-12">
            <h4 class="stat-label mb-8 text-center uppercase tracking-widest">Resumen de Recargas</h4>
            <div id="recarga_list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
        </div>

        <div class="mb-20">
            <h4 class="stat-label mb-6 italic px-4 border-l-4 border-blue-800 ml-2 uppercase text-slate-700">Eficiencia por Supervisor</h4>
            <div id="supervisor_grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://raw.githubusercontent.com/gmt-gestion01/monitor-ventas/main/ventas.csv';
        let globalData = [];

        async function initData() {
            const led = document.getElementById('status_led');
            const statusText = document.getElementById('status_text');

            try {
                // Forzar la recarga del archivo sin caché del navegador
                const response = await fetch(`${CSV_URL}?nocache=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Error al conectar con GitHub');
                
                const csvText = await response.text();
                if (csvText.length < 10) throw new Error('Archivo vacío');

                localStorage.setItem('gmt_ventas_local', csvText);
                parseAndRender(csvText);

                led.className = "h-3 w-3 rounded-full bg-emerald-500 animate-pulse";
                statusText.innerText = "Sincronizado (GitHub)";

            } catch (err) {
                console.warn("Error GitHub:", err);
                const local = localStorage.getItem('gmt_ventas_local');
                if (local) {
                    parseAndRender(local);
                    led.className = "h-3 w-3 rounded-full bg-amber-500";
                    statusText.innerText = "Modo Offline (Cache)";
                } else {
                    led.className = "h-3 w-3 rounded-full bg-red-500";
                    statusText.innerText = "Error de Conexión";
                }
            }
        }

        function parseAndRender(csv) {
            const lines = csv.split(/\r?\n/).filter(l => l.trim().length > 0);
            const sep = lines[0].includes(';') ? ';' : ',';
            
            globalData = lines.slice(1).map(line => {
                const c = line.split(sep).map(x => x.replace(/['"]+/g, '').trim());
                if (!c[0]) return null;
                
                let recValue = 0;
                if(c[7] && !c[7].toUpperCase().includes("SIN")) {
                    recValue = parseFloat(c[7].replace(/[^0-9.]/g, '')) || 0;
                }

                return {
                    dn: c[0], fVenta: c[1], supervisor: c[2] || "S/S",
                    esAlta: c[3] && !c[3].toUpperCase().includes("SIN") && c[3].toUpperCase() !== "NO",
                    esTrafico: c[6] === "SI" || c[6] === "CON TRAFICO" || c[6] === "TRAFICO",
                    esEnrolado: c[8] === "SI" || c[8] === "ENROLADO",
                    recargaTxt: c[7] || "SIN RECARGA",
                    recargaVal: recValue
                };
            }).filter(d => d !== null);

            renderDashboard();
        }

        function setKPI(total, meta, dias, idFlag, idPct, idGap) {
            const target = dias * meta;
            const pct = Math.round((total / target) * 100) || 0;
            const gap = total - target;
            
            document.getElementById(idPct).innerText = pct + "%";
            document.getElementById(idGap).innerText = (gap >= 0 ? "+" : "") + gap;
            document.getElementById(idFlag).style.backgroundColor = pct >= 98 ? '#4ade80' : pct < 89 ? '#f87171' : '#fbbf24';
        }

        function renderDashboard() {
            const total = globalData.length;
            const dates = [...new Set(globalData.map(d => d.fVenta))].sort();
            const dias = dates.length || 1;

            // Bloque Superior
            document.getElementById('k_bruto').innerText = total;
            document.getElementById('k_ritmo').innerText = `Ritmo: ${Math.round(total/dias)} / día`;
            setKPI(total, 509, dias, 'flag_509', 'k_cumplimiento_509', 'k_gap_509');
            setKPI(total, 604, dias, 'flag_604', 'k_cumplimiento_604', 'k_gap_604');

            // Sub-detalles
            const altas = globalData.filter(d => d.esAlta).length;
            const trafico = globalData.filter(d => d.esTrafico).length;
            const enrol = globalData.filter(d => d.esEnrolado).length;

            document.getElementById('alta_rel').innerText = Math.round((altas/total)*100) + "%";
            document.getElementById('alta_abs').innerText = altas + " ud";
            document.getElementById('trafico_rel').innerText = Math.round((trafico/total)*100) + "%";
            document.getElementById('trafico_abs').innerText = trafico + " ud";
            document.getElementById('enrol_rel_main').innerText = Math.round((enrol/total)*100) + "%";

            const recs = globalData.filter(d => d.recargaVal > 0);
            const arpu = recs.length > 0 ? Math.round(recs.reduce((s,d)=>s+d.recargaVal,0)/recs.length) : 0;
            document.getElementById('k_arpu').innerText = "$" + arpu;

            // Gráfica de Líneas
            const counts = dates.map(dt => globalData.filter(d => d.fVenta === dt).length);
            Plotly.newPlot('g_tendencia', [
                { x: dates, y: counts, name: 'Real', type: 'scatter', mode: 'lines+markers+text', text: counts, textposition: 'top center', line: {color: '#1e3a8a', width: 3, shape: 'spline'} },
                { x: dates, y: dates.map(() => 604), name: 'Meta GMT', line: {color: '#f97316', dash: 'dash'} },
                { x: dates, y: dates.map(() => 509), name: 'Meta Movistar', line: {color: '#10b981', dash: 'dash'} }
            ], { paper_bgcolor: 'rgba(0,0,0,0)', margin: {t:20, b:40, l:40, r:20} }, {responsive: true, displayModeBar: false});

            // Recargas
            const rMap = {};
            globalData.forEach(d => { rMap[d.recargaTxt] = (rMap[d.recargaTxt] || 0) + 1; });
            document.getElementById('recarga_list').innerHTML = Object.entries(rMap).sort((a,b)=>b[1]-a[1]).map(([l,v]) => `
                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center border border-slate-100">
                    <div><p class="text-[9px] font-black uppercase text-slate-400 mb-1">${l}</p>
                    <p class="text-xs font-bold text-blue-500">${Math.round((v/total)*100)}%</p></div>
                    <p class="text-xl font-black text-slate-800">${v}</p>
                </div>`).join('');

            // Grid Supervisores
            const sups = [...new Set(globalData.map(d => d.supervisor))].sort();
            document.getElementById('supervisor_grid').innerHTML = sups.map(s => {
                const ds = globalData.filter(x => x.supervisor === s);
                const n = ds.length;
                return `
                    <div class="sup-card p-6">
                        <p class="text-[11px] font-black text-blue-900 border-b pb-2 mb-4 uppercase italic">${s}</p>
                        <p class="text-3xl font-black text-slate-800 text-center mb-4">${n}</p>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-blue-50 p-2 rounded-xl"><p class="text-[7px] uppercase font-bold text-blue-400">Alta</p><p class="text-xs font-black">${Math.round((ds.filter(x=>x.esAlta).length/n)*100)}%</p></div>
                            <div class="bg-orange-50 p-2 rounded-xl"><p class="text-[7px] uppercase font-bold text-orange-400">Traf</p><p class="text-xs font-black">${Math.round((ds.filter(x=>x.esTrafico).length/n)*100)}%</p></div>
                            <div class="bg-emerald-50 p-2 rounded-xl"><p class="text-[7px] uppercase font-bold text-emerald-400">Enrol</p><p class="text-xs font-black">${Math.round((ds.filter(x=>x.esEnrolado).length/n)*100)}%</p></div>
                        </div>
                    </div>`;
            }).join('');
        }

        window.onload = initData;
    </script>
</body>
</html>
