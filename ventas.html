<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT | MONITOR VENTAS LOCAL</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        
        .bg-main-dark { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); }
        .glass-card { background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
        .stat-label { font-size: 0.65rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; }
        .sup-card { transition: all 0.2s; border: 1px solid #e2e8f0; border-radius: 2.5rem; background: white; overflow: hidden; }
        .sup-card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }
        
        .logo-gmt {
            background: linear-gradient(180deg, #ff9d42 0%, #ff6b00 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 1px 1px 0px #b45309; display: inline-block;
        }
        .logo-ventas {
            background: linear-gradient(180deg, #58a5ff 0%, #0056ce 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 1px 1px 0px #1e40af; display: inline-block;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-center gap-6 mb-10">
            <div class="text-center lg:text-left">
                <h1 class="text-6xl font-black tracking-tighter uppercase italic py-2">
                    <span class="logo-gmt">GMT</span>
                    <span class="logo-ventas">VENTAS</span>
                </h1>
                <p class="text-slate-400 font-bold text-[11px] uppercase tracking-[0.45em] mt-[-4px] pl-1">
                    Sincronizaci√≥n Autom√°tica | Local Data
                </p>
            </div>
            
            <div class="flex gap-3 bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                <select id="month_filter" onchange="updateDayFilter()" class="bg-transparent px-4 py-2 font-black text-xs uppercase outline-none border-r border-slate-100 italic text-blue-600 cursor-pointer"></select>
                <select id="day_filter" onchange="render()" class="bg-transparent px-4 py-2 font-black text-xs uppercase outline-none italic cursor-pointer"></select>
            </div>
        </header>

        <div id="dashboard_ui">
            <div class="glass-card rounded-[3rem] overflow-hidden mb-8 shadow-xl">
                <div class="grid grid-cols-1 md:grid-cols-2 text-white text-center">
                    <div class="bg-main-dark p-12 md:border-r border-white/10 relative overflow-hidden">
                        <p class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-200 mb-2 relative">Ventas Brutas</p>
                        <h2 id="total_ventas" class="text-8xl font-black italic leading-none relative">0</h2>
                    </div>
                    <div class="bg-slate-900 p-12 relative overflow-hidden">
                        <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-2">Efectividad Tr√°fico</p>
                        <h2 id="perc_traf" class="text-7xl font-black italic text-emerald-400">0%</h2>
                        <p id="abs_traf" class="text-xs font-bold text-slate-500 mt-2 uppercase tracking-widest">0 Unidades Totales</p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-8 rounded-[2.5rem] mb-8">
                <h4 class="stat-label mb-6 italic text-center text-slate-600 uppercase tracking-[0.3em]">Tendencia de Ventas Diarias</h4>
                <div id="g_tendencia" style="height: 350px;"></div>
            </div>

            <div class="mb-20">
                <div class="flex items-center gap-4 mb-8">
                    <div class="h-[2px] flex-grow bg-slate-200"></div>
                    <h4 class="stat-label italic uppercase text-slate-700 tracking-widest">Monitor por Supervisor</h4>
                    <div class="h-[2px] flex-grow bg-slate-200"></div>
                </div>
                <div id="supervisor_grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
            </div>
        </div>
    </div>

    <script>
        let globalRawData = [];

        // Funci√≥n para cargar el CSV local autom√°ticamente
        async function autoLoadLocalCSV() {
            try {
                // Busca ventas.csv en la misma carpeta. El timestamp (?v=...) evita el cach√©.
                const res = await fetch(`ventas.csv?v=${Date.now()}`);
                if (!res.ok) throw new Error("No se encontr√≥ el archivo ventas.csv");
                
                const text = await res.text();
                const lines = text.split(/\r?\n/).filter(l => l.trim().length > 5);
                const sep = lines[0].includes(';') ? ';' : ',';
                
                globalRawData = lines.slice(1).map(line => {
                    const c = line.split(sep).map(x => x.replace(/['"]+/g, '').trim());
                    if(!c[1]) return null;
                    
                    return {
                        fVenta: c[1],
                        supervisor: (c[2] || "S/S").toUpperCase(),
                        esAlta: c[3] && c[3].toUpperCase() !== "SIN ALTA" && c[3].toUpperCase() !== "NO",
                        esTrafico: c[6] && (c[6].toUpperCase().includes("TRAFICO") || c[6].toUpperCase() === "SI"),
                        esEnrolado: c[8] && (c[8].toUpperCase().includes("ENROLADO") || c[8].toUpperCase() === "SI"),
                        mes: (c[9] || "FEBRERO").toLowerCase()
                    };
                }).filter(d => d !== null);

                const meses = [...new Set(globalRawData.map(d => d.mes))];
                document.getElementById('month_filter').innerHTML = meses.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
                updateDayFilter();

            } catch (err) {
                console.error("Error cargando el archivo local:", err);
                alert("Error: No se pudo encontrar 'ventas.csv' en la carpeta local.");
            }
        }

        function updateDayFilter() {
            const selMes = document.getElementById('month_filter').value;
            const days = [...new Set(globalRawData.filter(d => d.mes === selMes).map(d => d.fVenta))].sort();
            document.getElementById('day_filter').innerHTML = '<option value="ALL">üóìÔ∏è TODOS LOS D√çAS</option>' + days.map(d => `<option value="${d}">${d}</option>`).join('');
            render();
        }

        function render() {
            const selMes = document.getElementById('month_filter').value;
            const selDia = document.getElementById('day_filter').value;
            let data = globalRawData.filter(d => d.mes === selMes);
            if(selDia !== "ALL") data = data.filter(d => d.fVenta === selDia);

            const total = data.length;
            const trafData = data.filter(x => x.esTrafico);
            
            document.getElementById('total_ventas').innerText = total;
            document.getElementById('perc_traf').innerText = total > 0 ? Math.round((trafData.length/total)*100) + "%" : "0%";
            document.getElementById('abs_traf').innerText = `${trafData.length} Unidades con Tr√°fico`;

            const dates = [...new Set(data.map(d => d.fVenta))].sort();
            const counts = dates.map(dt => data.filter(x => x.fVenta === dt).length);
            
            Plotly.newPlot('g_tendencia', [{
                x: dates, y: counts, type: 'scatter', mode: 'lines+markers+text',
                text: counts, textposition: 'top center',
                line: {color: '#1e3a8a', width: 4, shape: 'spline'},
                marker: {size: 10, color: '#ff6b00'}
            }], { 
                paper_bgcolor: 'rgba(0,0,0,0)', 
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: {t:20, b:40, l:40, r:20},
                xaxis: { gridcolor: '#f1f5f9' },
                yaxis: { gridcolor: '#f1f5f9', range: [0, Math.max(...counts) * 1.3] }
            }, {responsive: true, displayModeBar: false});

            const supers = [...new Set(data.map(d => d.supervisor))].sort();
            document.getElementById('supervisor_grid').innerHTML = supers.map(s => {
                const dSup = data.filter(x => x.supervisor === s);
                const v = dSup.length;
                return `
                    <div class="sup-card p-6 shadow-sm">
                        <p class="text-[11px] font-black text-blue-900 border-b border-slate-100 pb-2 mb-4 uppercase italic tracking-tighter">${s}</p>
                        <div class="text-center mb-4">
                            <p class="stat-label text-[8px]">Ventas</p>
                            <p class="text-4xl font-black text-slate-800">${v}</p>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="bg-blue-50 p-2 rounded-xl text-center"><p class="stat-label text-[6px] text-blue-500">Alta</p><p class="text-[11px] font-black">${Math.round((dSup.filter(x=>x.esAlta).length/v)*100)||0}%</p></div>
                            <div class="bg-orange-50 p-2 rounded-xl text-center"><p class="stat-label text-[6px] text-orange-500">Traf</p><p class="text-[11px] font-black">${Math.round((dSup.filter(x=>x.esTrafico).length/v)*100)||0}%</p></div>
                            <div class="bg-emerald-50 p-2 rounded-xl text-center"><p class="stat-label text-[6px] text-emerald-500">Enrol</p><p class="text-[11px] font-black">${Math.round((dSup.filter(x=>x.esEnrolado).length/v)*100)||0}%</p></div>
                        </div>
                    </div>`;
            }).join('');
        }

        // Ejecutar carga al iniciar
        window.onload = autoLoadLocalCSV;
    </script>
</body>
</html>
