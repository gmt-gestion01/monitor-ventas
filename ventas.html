<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GMT | MONITOR ESTRATÉGICO</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        /* Estilos de las tarjetas superiores */
        .kpi-container { border-radius: 2rem; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .bg-gmt-dark { background-color: #11235a; }
        .bg-gmt-green { background-color: #00936a; }
        .bg-gmt-orange { background-color: #d35400; }
        
        .filter-select {
            background: white; border-radius: 0.75rem; padding: 0.5rem 1rem;
            font-weight: 800; text-transform: uppercase; font-size: 0.7rem; border: 1px solid #e2e8f0;
        }
        .chart-card { background: white; border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="p-4">

    <div class="max-w-[1400px] mx-auto">
        
        <div class="flex justify-end gap-2 mb-4">
            <select id="month_filter" onchange="updateDayFilter()" class="filter-select"></select>
            <select id="day_filter" onchange="render()" class="filter-select"></select>
        </div>

        <div class="kpi-container mb-8 bg-white">
            <div class="grid grid-cols-1 md:grid-cols-3 text-white">
                <div class="bg-gmt-dark p-8 text-center border-r border-white/10">
                    <p class="text-[10px] font-black uppercase tracking-widest opacity-80 mb-2">Ventas Brutas</p>
                    <h2 id="kpi_ventas" class="text-7xl font-black mb-1">0</h2>
                    <p id="kpi_ritmo" class="text-[10px] font-bold opacity-70">RITMO: 0 / DÍA</p>
                </div>
                <div class="bg-gmt-green p-8 text-center border-r border-white/10 relative">
                    <p class="text-[10px] font-black uppercase tracking-widest opacity-80 mb-2">Meta Movistar (509)</p>
                    <h2 id="kpi_meta_mov" class="text-7xl font-black mb-1">0%</h2>
                    <p id="kpi_meta_mov_abs" class="text-xl font-bold">-0</p>
                    <div class="absolute top-1/2 left-4 w-3 h-3 bg-pink-400 rounded-full animate-pulse"></div>
                </div>
                <div class="bg-gmt-orange p-8 text-center relative">
                    <p class="text-[10px] font-black uppercase tracking-widest opacity-80 mb-2">Meta GMT (604)</p>
                    <h2 id="kpi_meta_gmt" class="text-7xl font-black mb-1">0%</h2>
                    <p id="kpi_meta_gmt_abs" class="text-xl font-bold">-0</p>
                    <div class="absolute top-1/2 left-4 w-3 h-3 bg-pink-300 rounded-full opacity-50"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 p-6 gap-4 text-center">
                <div>
                    <p class="text-[9px] font-black text-blue-600 uppercase mb-1">Activación (Altas)</p>
                    <p id="sub_alta" class="text-3xl font-black text-slate-800">0% <span class="text-xs font-normal text-slate-400">0 ud</span></p>
                </div>
                <div>
                    <p class="text-[9px] font-black text-orange-500 uppercase mb-1">Tráfico Real</p>
                    <p id="sub_traf" class="text-3xl font-black text-slate-800">0% <span class="text-xs font-normal text-slate-400">0 ud</span></p>
                </div>
                <div>
                    <p class="text-[9px] font-black text-blue-500 uppercase mb-1">Promedio ARPU</p>
                    <p id="sub_arpu" class="text-3xl font-black text-slate-800">$0</p>
                </div>
                <div>
                    <p class="text-[9px] font-black text-emerald-500 uppercase mb-1">Enrolamiento</p>
                    <p id="sub_enro" class="text-3xl font-black text-slate-800">0%</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <div class="chart-card">
                <h3 class="text-center font-black text-slate-600 text-sm uppercase mb-4">Tendencia Horas (o Unidades)</h3>
                <div id="g_tendencia" style="height: 350px;"></div>
            </div>

            <div class="chart-card">
                <h3 class="text-center font-black text-slate-600 text-sm uppercase mb-4">Total Acumulado por Gerente</h3>
                <div id="g_gerente" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <script>
        let globalRawData = [];
        const GITHUB_URL = "https://raw.githubusercontent.com/gmt-gestion01/monitor-ventas/main/ventas.csv";

        async function autoLoadCSV() {
            try {
                const res = await fetch(`${GITHUB_URL}?v=${Date.now()}`);
                const text = await res.text();
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
                const sep = lines[0].includes(';') ? ';' : ',';
                
                globalRawData = lines.slice(1).map(line => {
                    const c = line.split(sep).map(x => x.replace(/['"]+/g, '').trim());
                    if(!c[1]) return null;
                    return {
                        fVenta: c[1],
                        supervisor: (c[2] || "S/S").toUpperCase(),
                        gerente: (c[10] || "SIN GERENCIA").toUpperCase(), // Asumiendo columna 10 para gerente
                        esAlta: c[3] && c[3].toUpperCase() !== "SIN ALTA" && c[3].toUpperCase() !== "NO",
                        arpu: parseFloat(c[5]) || 0,
                        esTrafico: c[6] && (c[6].toUpperCase().includes("TRAFICO") || c[6].toUpperCase() === "SI"),
                        esEnrolado: c[8] && (c[8].toUpperCase().includes("ENROLADO") || c[8].toUpperCase() === "SI"),
                        mes: (c[9] || "FEBRERO").toLowerCase()
                    };
                }).filter(d => d !== null);

                const meses = [...new Set(globalRawData.map(d => d.mes))].sort();
                document.getElementById('month_filter').innerHTML = meses.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
                updateDayFilter();
            } catch (err) { console.error(err); }
        }

        function updateDayFilter() {
            const selMes = document.getElementById('month_filter').value;
            const days = [...new Set(globalRawData.filter(d => d.mes === selMes).map(d => d.fVenta))].sort();
            document.getElementById('day_filter').innerHTML = '<option value="ALL">TODOS LOS DÍAS</option>' + days.map(d => `<option value="${d}">${d}</option>`).join('');
            render();
        }

        function render() {
            const selMes = document.getElementById('month_filter').value;
            const selDia = document.getElementById('day_filter').value;
            let data = globalRawData.filter(d => d.mes === selMes);
            if(selDia !== "ALL") data = data.filter(d => d.fVenta === selDia);

            const total = data.length;
            const altas = data.filter(x => x.esAlta).length;
            const trafico = data.filter(x => x.esTrafico).length;
            const enrolado = data.filter(x => x.esEnrolado).length;
            const sumArpu = data.reduce((acc, curr) => acc + curr.arpu, 0);
            
            // Cálculos KPIs
            document.getElementById('kpi_ventas').innerText = total;
            const diasActivos = [...new Set(data.map(d => d.fVenta))].length || 1;
            document.getElementById('kpi_ritmo').innerText = `RITMO: ${Math.round(total/diasActivos)} / DÍA`;
            
            // Metas (Ejemplo con tus números 509 y 604)
            const metaMov = 509; const metaGmt = 604;
            document.getElementById('kpi_meta_mov').innerText = Math.round((total/metaMov)*100) + "%";
            document.getElementById('kpi_meta_mov_abs').innerText = (total - metaMov);
            document.getElementById('kpi_meta_gmt').innerText = Math.round((total/metaGmt)*100) + "%";
            document.getElementById('kpi_meta_gmt_abs').innerText = (total - metaGmt);

            // Secundarios
            document.getElementById('sub_alta').innerHTML = `${Math.round((altas/total)*100)||0}% <span class="text-xs font-normal text-slate-400">${altas} ud</span>`;
            document.getElementById('sub_traf').innerHTML = `${Math.round((trafico/total)*100)||0}% <span class="text-xs font-normal text-slate-400">${trafico} ud</span>`;
            document.getElementById('sub_arpu').innerText = `$${Math.round(sumArpu/total)||0}`;
            document.getElementById('sub_enro').innerText = `${Math.round((enrolado/total)*100)||0}%`;

            // Gráfica Tendencia
            const dates = [...new Set(data.map(d => d.fVenta))].sort();
            const counts = dates.map(dt => data.filter(x => x.fVenta === dt).length);
            Plotly.newPlot('g_tendencia', [{
                x: dates, y: counts, type: 'scatter', mode: 'lines+markers+text',
                text: counts, textposition: 'top center',
                line: {color: '#2563eb', width: 2},
                marker: {size: 8, color: '#2563eb', line: {color: 'white', width: 2}}
            }], { 
                margin: {t:30, b:40, l:40, r:20},
                xaxis: { gridcolor: '#f1f5f9' },
                yaxis: { gridcolor: '#f1f5f9' }
            }, {responsive: true, displayModeBar: false});

            // Gráfica Gerentes
            const gers = [...new Set(data.map(d => d.gerente))];
            const gerCounts = gers.map(g => data.filter(x => x.gerente === g).length);
            // Ordenar de mayor a menor
            const gerData = gers.map((g, i) => ({name: g, val: gerCounts[i]})).sort((a,b) => a.val - b.val);

            Plotly.newPlot('g_gerente', [{
                y: gerData.map(d => d.name), x: gerData.map(d => d.val),
                type: 'bar', orientation: 'h',
                marker: {color: '#2563eb'},
                text: gerData.map(d => d.val + " ud"), textposition: 'auto',
            }], {
                margin: {t:10, b:20, l:120, r:20},
                xaxis: { showgrid: false },
                yaxis: { tickfont: {size: 10, weight: 'bold'} }
            }, {responsive: true, displayModeBar: false});
        }

        window.onload = autoLoadCSV;
    </script>
</body>
</html>
